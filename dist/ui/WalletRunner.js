"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.WalletRunner = void 0;

var _constants = require("./constants");

var _services = require("../services");

var _EventMiddleware = require("../services/EventMiddleware");

var _constants2 = require("../services/constants");

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  function adopt(value) {
    return value instanceof P ? value : new P(function (resolve) {
      resolve(value);
    });
  }

  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

class WalletRunner {
  constructor(seed, storage, spinner, popUp) {
    this.seed = seed;
    this.crypto = require('opendsu').loadApi('crypto');
    this.hash = this.crypto.sha256(this.seed);
    this.spinner = spinner;
    this.popUp = popUp;
    this.storage = storage;
  }

  getIframeBase() {
    var iPath = window.location.pathname;
    return iPath.split("loader/")[0] + "loader/iframe/";
  }

  createTimerElement() {
    var script = document.createElement('script');
    script.src = './Timer.js';
    return script;
  }

  createContainerIFrame(useSeedForIFrameSource) {
    var iframe = document.createElement('iframe');
    Object.entries(_constants.IFRAME_DEFS.ATTRIBUTES).forEach(_ref => {
      var [key, value] = _ref;
      return iframe.setAttribute(key, value);
    });
    Object.entries(_constants.IFRAME_DEFS.STYLE).forEach(_ref2 => {
      var [key, value] = _ref2;
      return iframe.style[key] = value;
    });
    iframe.src = window.location.origin + this.getIframeBase() + (useSeedForIFrameSource ? this.seed : this.hash);
    return iframe;
  }

  removeElementsFromUI(iframe, removeSpinner, removeIFrame, removeRest) {
    if (removeIFrame && removeSpinner && removeRest) {
      document.body.innerHTML = '';
      return;
    }

    if (removeIFrame) iframe.remove();
    if (removeSpinner) this.spinner.remove();
    if (removeRest) try {
      document.querySelectorAll("body > *:not(iframe):not(.loader-parent-container)").forEach(node => node.remove());
    } catch (e) {}
  }

  setupLoadEventsListener(navigatorUtils, iframe) {
    var eventMiddleware = new _EventMiddleware.EventMiddleWare(iframe, this.hash);
    var self = this;
    eventMiddleware.registerQuery(_constants2.ServiceWorkerConstants.QUERIES.SEED, () => {
      return {
        seed: self.seed
      };
    });
    eventMiddleware.onStatus(_constants2.ServiceWorkerConstants.STATE.COMPLETED, () => {
      if (iframe.hasAttribute("app-placeholder")) {
        self.removeElementsFromUI(iframe, true, false, false);
        iframe.removeAttribute("app-placeholder");
        document.body.prepend(iframe);
        return;
      }

      self.removeElementsFromUI(iframe, false, true, false);
      iframe.hidden = false;
    });
    eventMiddleware.onStatus(_constants2.ServiceWorkerConstants.STATE.SIGN_OUT, data => {
      navigatorUtils.unregisterAllServiceWorkers(err => {
        if (data.deleteSeed) self.storage.removeItem(_constants2.StorageKeys.SEED_CAGE);
        window.location.reload();
      });
    });
    eventMiddleware.onStatus(_constants2.ServiceWorkerConstants.STATE.ERROR, () => {
      throw new _services.ServiceWorkerError("Unable to load application");
    });
    iframe.hidden = true;
  }

  sendCompletedEvent(iframe) {
    var iframeDocument = iframe.contentDocument || (iframe.contentWindow ? iframe.contentWindow.document : undefined);
    if (!iframeDocument) throw new _services.ServiceWorkerError("Could not find Iframe document");

    if (iframeDocument.readyState !== _constants2.ServiceWorkerConstants.STATE.COMPLETE) {
      console.log('Event "completed" can be emitted only when iframe is loaded!');
      return;
    }

    var iframeIdentity = iframe.getAttribute('identity');

    if (!iframeIdentity) {
      console.log('Event "completed" can not be emitted if no identity was found!');
      return;
    }

    var completedEvent = new CustomEvent(iframeIdentity, {
      detail: {
        status: _constants2.ServiceWorkerConstants.STATE.COMPLETED
      }
    });
    document.dispatchEvent(completedEvent);
  }

  setupSeedRequestListener(navigatorUtils) {
    navigatorUtils.addServiceWorkerEventListener(_constants2.ServiceWorkerConstants.EVENTS.MESSAGE, e => {
      if (!e.data || e.data.query !== "seed") {
        return;
      }

      var swWorkerIdentity = e.data.identity;

      if (swWorkerIdentity === this.hash) {
        e.source.postMessage({
          seed: this.seed
        });
      }
    });
  }

  setupProgressListener() {
    document.addEventListener(_constants2.ServiceWorkerConstants.EVENTS.PROGRESS, e => __awaiter(this, void 0, void 0, function* () {
      var {
        progress,
        status
      } = e.detail;

      if (progress === 100) {
        yield this.spinner.remove();
        return;
      }

      if (this.spinner.isVisible()) yield this.spinner.update(status);else yield this.spinner.show(status);
    }));
  }

  run(navigatorUtils) {
    return __awaiter(this, void 0, void 0, function* () {
      if (navigatorUtils.areServiceWorkersEnabled() && !navigatorUtils.areServiceWorkersSupported()) return this.popUp.ask("Your current browser doe's support this application");
      var iframe = this.createContainerIFrame(!navigatorUtils.areServiceWorkersEnabled());
      this.setupLoadEventsListener(navigatorUtils, iframe);
      var self = this;

      if (navigatorUtils.areServiceWorkersEnabled()) {
        var loadingInterval,
            loadingProgress = 10;
        yield this.spinner.show("Loading Application");
        iframe.addEventListener(_constants2.ServiceWorkerConstants.EVENTS.LOAD, () => {
          self.sendCompletedEvent(iframe);
        });
        document.appendChild(iframe);
        var timer = this.createTimerElement();
        document.appendChild(timer);
        navigatorUtils.registerPwaServiceWorker();
        return;
      }

      this.setupSeedRequestListener(navigatorUtils);
      this.setupProgressListener();
      navigatorUtils.unregisterAllServiceWorkers(() => {
        navigatorUtils.registerServiceWorker({
          name: "swLoader.js",
          path: "swLoader.js",
          scope: self.getIframeBase()
        }, err => {
          if (err) throw err;
          iframe.addEventListener(_constants2.ServiceWorkerConstants.EVENTS.LOAD, () => {
            navigatorUtils.registerPwaServiceWorker();
            self.sendCompletedEvent(iframe);
          });
          document.body.appendChild(iframe);
        });
      });
    });
  }

}

exports.WalletRunner = WalletRunner;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInVpL1dhbGxldFJ1bm5lci5qcyJdLCJuYW1lcyI6WyJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJhZG9wdCIsInZhbHVlIiwicmVzb2x2ZSIsIlByb21pc2UiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJXYWxsZXRSdW5uZXIiLCJjb25zdHJ1Y3RvciIsInNlZWQiLCJzdG9yYWdlIiwic3Bpbm5lciIsInBvcFVwIiwiY3J5cHRvIiwicmVxdWlyZSIsImxvYWRBcGkiLCJoYXNoIiwic2hhMjU2IiwiZ2V0SWZyYW1lQmFzZSIsImlQYXRoIiwid2luZG93IiwibG9jYXRpb24iLCJwYXRobmFtZSIsInNwbGl0IiwiY3JlYXRlVGltZXJFbGVtZW50Iiwic2NyaXB0IiwiZG9jdW1lbnQiLCJjcmVhdGVFbGVtZW50Iiwic3JjIiwiY3JlYXRlQ29udGFpbmVySUZyYW1lIiwidXNlU2VlZEZvcklGcmFtZVNvdXJjZSIsImlmcmFtZSIsIk9iamVjdCIsImVudHJpZXMiLCJJRlJBTUVfREVGUyIsIkFUVFJJQlVURVMiLCJmb3JFYWNoIiwia2V5Iiwic2V0QXR0cmlidXRlIiwiU1RZTEUiLCJzdHlsZSIsIm9yaWdpbiIsInJlbW92ZUVsZW1lbnRzRnJvbVVJIiwicmVtb3ZlU3Bpbm5lciIsInJlbW92ZUlGcmFtZSIsInJlbW92ZVJlc3QiLCJib2R5IiwiaW5uZXJIVE1MIiwicmVtb3ZlIiwicXVlcnlTZWxlY3RvckFsbCIsIm5vZGUiLCJzZXR1cExvYWRFdmVudHNMaXN0ZW5lciIsIm5hdmlnYXRvclV0aWxzIiwiZXZlbnRNaWRkbGV3YXJlIiwiRXZlbnRNaWRkbGVXYXJlIiwic2VsZiIsInJlZ2lzdGVyUXVlcnkiLCJTZXJ2aWNlV29ya2VyQ29uc3RhbnRzIiwiUVVFUklFUyIsIlNFRUQiLCJvblN0YXR1cyIsIlNUQVRFIiwiQ09NUExFVEVEIiwiaGFzQXR0cmlidXRlIiwicmVtb3ZlQXR0cmlidXRlIiwicHJlcGVuZCIsImhpZGRlbiIsIlNJR05fT1VUIiwiZGF0YSIsInVucmVnaXN0ZXJBbGxTZXJ2aWNlV29ya2VycyIsImVyciIsImRlbGV0ZVNlZWQiLCJyZW1vdmVJdGVtIiwiU3RvcmFnZUtleXMiLCJTRUVEX0NBR0UiLCJyZWxvYWQiLCJFUlJPUiIsIlNlcnZpY2VXb3JrZXJFcnJvciIsInNlbmRDb21wbGV0ZWRFdmVudCIsImlmcmFtZURvY3VtZW50IiwiY29udGVudERvY3VtZW50IiwiY29udGVudFdpbmRvdyIsInVuZGVmaW5lZCIsInJlYWR5U3RhdGUiLCJDT01QTEVURSIsImNvbnNvbGUiLCJsb2ciLCJpZnJhbWVJZGVudGl0eSIsImdldEF0dHJpYnV0ZSIsImNvbXBsZXRlZEV2ZW50IiwiQ3VzdG9tRXZlbnQiLCJkZXRhaWwiLCJzdGF0dXMiLCJkaXNwYXRjaEV2ZW50Iiwic2V0dXBTZWVkUmVxdWVzdExpc3RlbmVyIiwiYWRkU2VydmljZVdvcmtlckV2ZW50TGlzdGVuZXIiLCJFVkVOVFMiLCJNRVNTQUdFIiwicXVlcnkiLCJzd1dvcmtlcklkZW50aXR5IiwiaWRlbnRpdHkiLCJzb3VyY2UiLCJwb3N0TWVzc2FnZSIsInNldHVwUHJvZ3Jlc3NMaXN0ZW5lciIsImFkZEV2ZW50TGlzdGVuZXIiLCJQUk9HUkVTUyIsInByb2dyZXNzIiwiaXNWaXNpYmxlIiwidXBkYXRlIiwic2hvdyIsInJ1biIsImFyZVNlcnZpY2VXb3JrZXJzRW5hYmxlZCIsImFyZVNlcnZpY2VXb3JrZXJzU3VwcG9ydGVkIiwiYXNrIiwibG9hZGluZ0ludGVydmFsIiwibG9hZGluZ1Byb2dyZXNzIiwiTE9BRCIsImFwcGVuZENoaWxkIiwidGltZXIiLCJyZWdpc3RlclB3YVNlcnZpY2VXb3JrZXIiLCJyZWdpc3RlclNlcnZpY2VXb3JrZXIiLCJuYW1lIiwicGF0aCIsInNjb3BlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBU0E7O0FBQ0E7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OztBQUNELFdBQUt6Qix3QkFBTCxDQUE4QjFDLGNBQTlCO0FBQ0EsV0FBS21ELHFCQUFMO0FBQ0FuRCxNQUFBQSxjQUFjLENBQUNpQiwyQkFBZixDQUEyQyxNQUFNO0FBQzdDakIsUUFBQUEsY0FBYyxDQUFDb0UscUJBQWYsQ0FBcUM7QUFDakNDLFVBQUFBLElBQUksRUFBRSxhQUQyQjtBQUVqQ0MsVUFBQUEsSUFBSSxFQUFFLGFBRjJCO0FBR2pDQyxVQUFBQSxLQUFLLEVBQUVwRSxJQUFJLENBQUNyQyxhQUFMO0FBSDBCLFNBQXJDLEVBSUlvRCxHQUFELElBQVM7QUFDUixjQUFJQSxHQUFKLEVBQ0ksTUFBTUEsR0FBTjtBQUNKdkMsVUFBQUEsTUFBTSxDQUFDeUUsZ0JBQVAsQ0FBd0IvQyxtQ0FBdUJ1QyxNQUF2QixDQUE4Qm9CLElBQXRELEVBQTRELE1BQU07QUFDOURoRSxZQUFBQSxjQUFjLENBQUNtRSx3QkFBZjtBQUNBaEUsWUFBQUEsSUFBSSxDQUFDdUIsa0JBQUwsQ0FBd0IvQyxNQUF4QjtBQUNILFdBSEQ7QUFJQUwsVUFBQUEsUUFBUSxDQUFDb0IsSUFBVCxDQUFjdUUsV0FBZCxDQUEwQnRGLE1BQTFCO0FBQ0gsU0FaRDtBQWFILE9BZEQ7QUFlSCxLQW5DZSxDQUFoQjtBQW9DSDs7QUFySnFCIiwic291cmNlc0NvbnRlbnQiOlsidmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XG4gICAgZnVuY3Rpb24gYWRvcHQodmFsdWUpIHsgcmV0dXJuIHZhbHVlIGluc3RhbmNlb2YgUCA/IHZhbHVlIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZSh2YWx1ZSk7IH0pOyB9XG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogYWRvcHQocmVzdWx0LnZhbHVlKS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcbiAgICB9KTtcbn07XG5pbXBvcnQgeyBJRlJBTUVfREVGUyB9IGZyb20gXCIuL2NvbnN0YW50c1wiO1xuaW1wb3J0IHsgU2VydmljZVdvcmtlckVycm9yIH0gZnJvbSBcIi4uL3NlcnZpY2VzXCI7XG5pbXBvcnQgeyBFdmVudE1pZGRsZVdhcmUgfSBmcm9tIFwiLi4vc2VydmljZXMvRXZlbnRNaWRkbGV3YXJlXCI7XG5pbXBvcnQgeyBTZXJ2aWNlV29ya2VyQ29uc3RhbnRzLCBTdG9yYWdlS2V5cyB9IGZyb20gXCIuLi9zZXJ2aWNlcy9jb25zdGFudHNcIjtcbmV4cG9ydCBjbGFzcyBXYWxsZXRSdW5uZXIge1xuICAgIGNvbnN0cnVjdG9yKHNlZWQsIHN0b3JhZ2UsIHNwaW5uZXIsIHBvcFVwKSB7XG4gICAgICAgIHRoaXMuc2VlZCA9IHNlZWQ7XG4gICAgICAgIHRoaXMuY3J5cHRvID0gcmVxdWlyZSgnb3BlbmRzdScpLmxvYWRBcGkoJ2NyeXB0bycpO1xuICAgICAgICB0aGlzLmhhc2ggPSB0aGlzLmNyeXB0by5zaGEyNTYodGhpcy5zZWVkKTtcbiAgICAgICAgdGhpcy5zcGlubmVyID0gc3Bpbm5lcjtcbiAgICAgICAgdGhpcy5wb3BVcCA9IHBvcFVwO1xuICAgICAgICB0aGlzLnN0b3JhZ2UgPSBzdG9yYWdlO1xuICAgIH1cbiAgICBnZXRJZnJhbWVCYXNlKCkge1xuICAgICAgICBsZXQgaVBhdGggPSB3aW5kb3cubG9jYXRpb24ucGF0aG5hbWU7XG4gICAgICAgIHJldHVybiBpUGF0aC5zcGxpdChcImxvYWRlci9cIilbMF0gKyBcImxvYWRlci9pZnJhbWUvXCI7XG4gICAgfVxuICAgIGNyZWF0ZVRpbWVyRWxlbWVudCgpIHtcbiAgICAgICAgY29uc3Qgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7XG4gICAgICAgIHNjcmlwdC5zcmMgPSAnLi9UaW1lci5qcyc7XG4gICAgICAgIHJldHVybiBzY3JpcHQ7XG4gICAgfVxuICAgIGNyZWF0ZUNvbnRhaW5lcklGcmFtZSh1c2VTZWVkRm9ySUZyYW1lU291cmNlKSB7XG4gICAgICAgIGNvbnN0IGlmcmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lmcmFtZScpO1xuICAgICAgICBPYmplY3QuZW50cmllcyhJRlJBTUVfREVGUy5BVFRSSUJVVEVTKS5mb3JFYWNoKChba2V5LCB2YWx1ZV0pID0+IGlmcmFtZS5zZXRBdHRyaWJ1dGUoa2V5LCB2YWx1ZSkpO1xuICAgICAgICBPYmplY3QuZW50cmllcyhJRlJBTUVfREVGUy5TVFlMRSkuZm9yRWFjaCgoW2tleSwgdmFsdWVdKSA9PiBpZnJhbWUuc3R5bGVba2V5XSA9IHZhbHVlKTtcbiAgICAgICAgaWZyYW1lLnNyYyA9IHdpbmRvdy5sb2NhdGlvbi5vcmlnaW4gKyB0aGlzLmdldElmcmFtZUJhc2UoKSArICh1c2VTZWVkRm9ySUZyYW1lU291cmNlID8gdGhpcy5zZWVkIDogdGhpcy5oYXNoKTtcbiAgICAgICAgcmV0dXJuIGlmcmFtZTtcbiAgICB9XG4gICAgcmVtb3ZlRWxlbWVudHNGcm9tVUkoaWZyYW1lLCByZW1vdmVTcGlubmVyLCByZW1vdmVJRnJhbWUsIHJlbW92ZVJlc3QpIHtcbiAgICAgICAgaWYgKHJlbW92ZUlGcmFtZSAmJiByZW1vdmVTcGlubmVyICYmIHJlbW92ZVJlc3QpIHtcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuaW5uZXJIVE1MID0gJyc7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlbW92ZUlGcmFtZSlcbiAgICAgICAgICAgIGlmcmFtZS5yZW1vdmUoKTtcbiAgICAgICAgaWYgKHJlbW92ZVNwaW5uZXIpXG4gICAgICAgICAgICB0aGlzLnNwaW5uZXIucmVtb3ZlKCk7XG4gICAgICAgIGlmIChyZW1vdmVSZXN0KVxuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFwiYm9keSA+ICo6bm90KGlmcmFtZSk6bm90KC5sb2FkZXItcGFyZW50LWNvbnRhaW5lcilcIilcbiAgICAgICAgICAgICAgICAgICAgLmZvckVhY2goKG5vZGUpID0+IG5vZGUucmVtb3ZlKCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIH1cbiAgICB9XG4gICAgc2V0dXBMb2FkRXZlbnRzTGlzdGVuZXIobmF2aWdhdG9yVXRpbHMsIGlmcmFtZSkge1xuICAgICAgICBjb25zdCBldmVudE1pZGRsZXdhcmUgPSBuZXcgRXZlbnRNaWRkbGVXYXJlKGlmcmFtZSwgdGhpcy5oYXNoKTtcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gICAgICAgIGV2ZW50TWlkZGxld2FyZS5yZWdpc3RlclF1ZXJ5KFNlcnZpY2VXb3JrZXJDb25zdGFudHMuUVVFUklFUy5TRUVELCAoKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4geyBzZWVkOiBzZWxmLnNlZWQgfTtcbiAgICAgICAgfSk7XG4gICAgICAgIGV2ZW50TWlkZGxld2FyZS5vblN0YXR1cyhTZXJ2aWNlV29ya2VyQ29uc3RhbnRzLlNUQVRFLkNPTVBMRVRFRCwgKCkgPT4ge1xuICAgICAgICAgICAgaWYgKGlmcmFtZS5oYXNBdHRyaWJ1dGUoXCJhcHAtcGxhY2Vob2xkZXJcIikpIHtcbiAgICAgICAgICAgICAgICBzZWxmLnJlbW92ZUVsZW1lbnRzRnJvbVVJKGlmcmFtZSwgdHJ1ZSwgZmFsc2UsIGZhbHNlKTtcbiAgICAgICAgICAgICAgICBpZnJhbWUucmVtb3ZlQXR0cmlidXRlKFwiYXBwLXBsYWNlaG9sZGVyXCIpO1xuICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkucHJlcGVuZChpZnJhbWUpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHNlbGYucmVtb3ZlRWxlbWVudHNGcm9tVUkoaWZyYW1lLCBmYWxzZSwgdHJ1ZSwgZmFsc2UpO1xuICAgICAgICAgICAgaWZyYW1lLmhpZGRlbiA9IGZhbHNlO1xuICAgICAgICB9KTtcbiAgICAgICAgZXZlbnRNaWRkbGV3YXJlLm9uU3RhdHVzKFNlcnZpY2VXb3JrZXJDb25zdGFudHMuU1RBVEUuU0lHTl9PVVQsIChkYXRhKSA9PiB7XG4gICAgICAgICAgICBuYXZpZ2F0b3JVdGlscy51bnJlZ2lzdGVyQWxsU2VydmljZVdvcmtlcnMoKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChkYXRhLmRlbGV0ZVNlZWQpXG4gICAgICAgICAgICAgICAgICAgIHNlbGYuc3RvcmFnZS5yZW1vdmVJdGVtKFN0b3JhZ2VLZXlzLlNFRURfQ0FHRSk7XG4gICAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uLnJlbG9hZCgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgICBldmVudE1pZGRsZXdhcmUub25TdGF0dXMoU2VydmljZVdvcmtlckNvbnN0YW50cy5TVEFURS5FUlJPUiwgKCkgPT4ge1xuICAgICAgICAgICAgdGhyb3cgbmV3IFNlcnZpY2VXb3JrZXJFcnJvcihgVW5hYmxlIHRvIGxvYWQgYXBwbGljYXRpb25gKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGlmcmFtZS5oaWRkZW4gPSB0cnVlO1xuICAgIH1cbiAgICBzZW5kQ29tcGxldGVkRXZlbnQoaWZyYW1lKSB7XG4gICAgICAgIGNvbnN0IGlmcmFtZURvY3VtZW50ID0gaWZyYW1lLmNvbnRlbnREb2N1bWVudCB8fCAoaWZyYW1lLmNvbnRlbnRXaW5kb3cgPyBpZnJhbWUuY29udGVudFdpbmRvdy5kb2N1bWVudCA6IHVuZGVmaW5lZCk7XG4gICAgICAgIGlmICghaWZyYW1lRG9jdW1lbnQpXG4gICAgICAgICAgICB0aHJvdyBuZXcgU2VydmljZVdvcmtlckVycm9yKGBDb3VsZCBub3QgZmluZCBJZnJhbWUgZG9jdW1lbnRgKTtcbiAgICAgICAgaWYgKGlmcmFtZURvY3VtZW50LnJlYWR5U3RhdGUgIT09IFNlcnZpY2VXb3JrZXJDb25zdGFudHMuU1RBVEUuQ09NUExFVEUpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdFdmVudCBcImNvbXBsZXRlZFwiIGNhbiBiZSBlbWl0dGVkIG9ubHkgd2hlbiBpZnJhbWUgaXMgbG9hZGVkIScpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGlmcmFtZUlkZW50aXR5ID0gaWZyYW1lLmdldEF0dHJpYnV0ZSgnaWRlbnRpdHknKTtcbiAgICAgICAgaWYgKCFpZnJhbWVJZGVudGl0eSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ0V2ZW50IFwiY29tcGxldGVkXCIgY2FuIG5vdCBiZSBlbWl0dGVkIGlmIG5vIGlkZW50aXR5IHdhcyBmb3VuZCEnKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBjb21wbGV0ZWRFdmVudCA9IG5ldyBDdXN0b21FdmVudChpZnJhbWVJZGVudGl0eSwgeyBkZXRhaWw6IHsgc3RhdHVzOiBTZXJ2aWNlV29ya2VyQ29uc3RhbnRzLlNUQVRFLkNPTVBMRVRFRCB9IH0pO1xuICAgICAgICBkb2N1bWVudC5kaXNwYXRjaEV2ZW50KGNvbXBsZXRlZEV2ZW50KTtcbiAgICB9XG4gICAgc2V0dXBTZWVkUmVxdWVzdExpc3RlbmVyKG5hdmlnYXRvclV0aWxzKSB7XG4gICAgICAgIG5hdmlnYXRvclV0aWxzLmFkZFNlcnZpY2VXb3JrZXJFdmVudExpc3RlbmVyKFNlcnZpY2VXb3JrZXJDb25zdGFudHMuRVZFTlRTLk1FU1NBR0UsIChlKSA9PiB7XG4gICAgICAgICAgICBpZiAoIWUuZGF0YSB8fCBlLmRhdGEucXVlcnkgIT09IFwic2VlZFwiKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3Qgc3dXb3JrZXJJZGVudGl0eSA9IGUuZGF0YS5pZGVudGl0eTtcbiAgICAgICAgICAgIGlmIChzd1dvcmtlcklkZW50aXR5ID09PSB0aGlzLmhhc2gpIHtcbiAgICAgICAgICAgICAgICBlLnNvdXJjZS5wb3N0TWVzc2FnZSh7XG4gICAgICAgICAgICAgICAgICAgIHNlZWQ6IHRoaXMuc2VlZCxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHNldHVwUHJvZ3Jlc3NMaXN0ZW5lcigpIHtcbiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihTZXJ2aWNlV29ya2VyQ29uc3RhbnRzLkVWRU5UUy5QUk9HUkVTUywgKGUpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGNvbnN0IHsgcHJvZ3Jlc3MsIHN0YXR1cyB9ID0gZS5kZXRhaWw7XG4gICAgICAgICAgICBpZiAocHJvZ3Jlc3MgPT09IDEwMCkge1xuICAgICAgICAgICAgICAgIHlpZWxkIHRoaXMuc3Bpbm5lci5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodGhpcy5zcGlubmVyLmlzVmlzaWJsZSgpKVxuICAgICAgICAgICAgICAgIHlpZWxkIHRoaXMuc3Bpbm5lci51cGRhdGUoc3RhdHVzKTtcbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLnNwaW5uZXIuc2hvdyhzdGF0dXMpO1xuICAgICAgICB9KSk7XG4gICAgfVxuICAgIHJ1bihuYXZpZ2F0b3JVdGlscykge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgaWYgKG5hdmlnYXRvclV0aWxzLmFyZVNlcnZpY2VXb3JrZXJzRW5hYmxlZCgpICYmICFuYXZpZ2F0b3JVdGlscy5hcmVTZXJ2aWNlV29ya2Vyc1N1cHBvcnRlZCgpKVxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnBvcFVwLmFzayhgWW91ciBjdXJyZW50IGJyb3dzZXIgZG9lJ3Mgc3VwcG9ydCB0aGlzIGFwcGxpY2F0aW9uYCk7XG4gICAgICAgICAgICBjb25zdCBpZnJhbWUgPSB0aGlzLmNyZWF0ZUNvbnRhaW5lcklGcmFtZSghbmF2aWdhdG9yVXRpbHMuYXJlU2VydmljZVdvcmtlcnNFbmFibGVkKCkpO1xuICAgICAgICAgICAgdGhpcy5zZXR1cExvYWRFdmVudHNMaXN0ZW5lcihuYXZpZ2F0b3JVdGlscywgaWZyYW1lKTtcbiAgICAgICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuICAgICAgICAgICAgaWYgKG5hdmlnYXRvclV0aWxzLmFyZVNlcnZpY2VXb3JrZXJzRW5hYmxlZCgpKSB7XG4gICAgICAgICAgICAgICAgbGV0IGxvYWRpbmdJbnRlcnZhbCwgbG9hZGluZ1Byb2dyZXNzID0gMTA7XG4gICAgICAgICAgICAgICAgeWllbGQgdGhpcy5zcGlubmVyLnNob3coYExvYWRpbmcgQXBwbGljYXRpb25gKTtcbiAgICAgICAgICAgICAgICBpZnJhbWUuYWRkRXZlbnRMaXN0ZW5lcihTZXJ2aWNlV29ya2VyQ29uc3RhbnRzLkVWRU5UUy5MT0FELCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHNlbGYuc2VuZENvbXBsZXRlZEV2ZW50KGlmcmFtZSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgZG9jdW1lbnQuYXBwZW5kQ2hpbGQoaWZyYW1lKTtcbiAgICAgICAgICAgICAgICBjb25zdCB0aW1lciA9IHRoaXMuY3JlYXRlVGltZXJFbGVtZW50KCk7XG4gICAgICAgICAgICAgICAgZG9jdW1lbnQuYXBwZW5kQ2hpbGQodGltZXIpO1xuICAgICAgICAgICAgICAgIG5hdmlnYXRvclV0aWxzLnJlZ2lzdGVyUHdhU2VydmljZVdvcmtlcigpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuc2V0dXBTZWVkUmVxdWVzdExpc3RlbmVyKG5hdmlnYXRvclV0aWxzKTtcbiAgICAgICAgICAgIHRoaXMuc2V0dXBQcm9ncmVzc0xpc3RlbmVyKCk7XG4gICAgICAgICAgICBuYXZpZ2F0b3JVdGlscy51bnJlZ2lzdGVyQWxsU2VydmljZVdvcmtlcnMoKCkgPT4ge1xuICAgICAgICAgICAgICAgIG5hdmlnYXRvclV0aWxzLnJlZ2lzdGVyU2VydmljZVdvcmtlcih7XG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IFwic3dMb2FkZXIuanNcIixcbiAgICAgICAgICAgICAgICAgICAgcGF0aDogXCJzd0xvYWRlci5qc1wiLFxuICAgICAgICAgICAgICAgICAgICBzY29wZTogc2VsZi5nZXRJZnJhbWVCYXNlKClcbiAgICAgICAgICAgICAgICB9LCAoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIpXG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgICAgICAgICAgIGlmcmFtZS5hZGRFdmVudExpc3RlbmVyKFNlcnZpY2VXb3JrZXJDb25zdGFudHMuRVZFTlRTLkxPQUQsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hdmlnYXRvclV0aWxzLnJlZ2lzdGVyUHdhU2VydmljZVdvcmtlcigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zZW5kQ29tcGxldGVkRXZlbnQoaWZyYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoaWZyYW1lKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG59Il0sImZpbGUiOiJ1aS9XYWxsZXRSdW5uZXIuanMifQ==
