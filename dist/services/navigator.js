"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ServiceWorkerError = exports.NavigatorUtils = void 0;
exports.getNavigatorUtils = getNavigatorUtils;

var _workboxWindow = require("workbox-window");

var _constants = require("./constants");

var __awaiter = void 0 && (void 0).__awaiter || function (thisArg, _arguments, P, generator) {
  function adopt(value) {
    return value instanceof P ? value : new P(function (resolve) {
      resolve(value);
    });
  }

  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
};

class ServiceWorkerError extends Error {
  constructor(message) {
    super(typeof message === 'string' ? message : message.message);
    this.type = "ServiceWorkerError";
  }

}

exports.ServiceWorkerError = ServiceWorkerError;
var navigatorUtils;

function getNavigatorUtils() {
  return navigatorUtils;
}

class NavigatorUtils {
  constructor(environment, spinner, popUp) {
    this.controllersChangeHandlers = [];
    this.webManifest = undefined;
    this.environment = environment;
    this.spinner = spinner;
    this.popUp = popUp;
    navigatorUtils = this;
  }

  getRegistrations(callback) {
    if (this.areServiceWorkersSupported()) return navigator.serviceWorker.getRegistrations().then(registrations => {
      callback(undefined, registrations);
    }).catch(e => {
      callback(new ServiceWorkerError("Service Workers are not supported or are restricted by browser settings"));
    });
    if (this.areServiceWorkersEnabled()) return callback(new ServiceWorkerError("Service Workers are not supported for this browser"));
    callback(undefined, []);
  }

  areServiceWorkersSupported() {
    return "serviceWorker" in navigator;
  }

  areServiceWorkersEnabled() {
    return this.environment.sw;
  }

  canUseServiceWorkers() {
    return this.areServiceWorkersEnabled() && this.areServiceWorkersSupported();
  }

  onServiceWorkerReady(name, registration, callback) {
    var {
      installing
    } = registration;

    if (installing) {
      installing.onerror = function (err) {
        console.error(err);
      };

      installing.addEventListener("statechange", res => {
        if (installing.state === "activated") {
          callback(undefined, registration);
        }

        console.log("Sw state", installing.state);
      });
    } else {
      this.controllersChangeHandlers.push({
        swName: name,
        registration: registration,
        callback: callback
      });
    }
  }

  registerServiceWorker(options, callback) {
    var {
      scope
    } = options;
    var self = this;

    if (this.areServiceWorkersSupported()) {
      console.log("SW Register:", options.path, JSON.stringify(scope));
      navigator.serviceWorker.register(options.path, scope).then(registration => {
        if (registration.active) {
          return callback(undefined, registration);
        }

        registration.onerror = function (err) {
          console.error("Service Worker Registration Failed", err);
        };

        self.onServiceWorkerReady(options.name, registration, callback);
      }, err => {
        console.error(err);
      }).catch(err => {
        console.error(err);
        return callback(new Error("Service worker registration failed."));
      });
    }
  }

  unregisterServiceWorker(sw, callback) {
    sw.unregister({
      immediate: true
    }).then(success => {
      if (!success) {
        console.log("Could not unregister sw ", sw);
        return callback(new Error("Could not unregister sw"));
      }

      callback();
    }).catch(callback);
  }

  getWebManifest(callback) {
    if (this.webManifest) return callback(undefined, this.webManifest);
    var self = this;
    fetch(_constants.LoaderConstants.MANIFEST_FILE).then(response => response.json()).then(manifest => {
      self.webManifest = manifest;
      callback(undefined, manifest);
    }).catch(err => {
      console.error("Cannot load manifest file at ".concat(_constants.LoaderConstants.MANIFEST_FILE), err);
      callback();
    });
  }

  clearServiceWorkerInScope(scope, callback) {
    if (this.areServiceWorkersSupported()) navigator.serviceWorker.getRegistration(scope).then(sw => {
      if (!sw) return callback(new Error("No Service worker found for scope ".concat(scope)));

      if (scope === sw.scope) {
        console.log("Refreshing ServiceWorker for scope ".concat(scope));
        return this.unregisterServiceWorker(sw, callback);
      } else {
        callback();
      }
    }).catch(callback);
  }

  sendMessage(message) {
    return new Promise(function (resolve, reject) {
      var messageChannel = new MessageChannel();

      messageChannel.port1.onmessage = function (event) {
        if (event.data.error) {
          reject(event.data.error);
        } else {
          resolve(event.data);
        }
      };

      if (navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage(message, [messageChannel.port2]);
      } else {
        navigator.serviceWorker.oncontrollerchange = function () {
          if (navigator.serviceWorker.controller) navigator.serviceWorker.controller.postMessage(message, [messageChannel.port2]);
        };
      }
    });
  }

  sendSeedToSW(seed, callback) {
    this.sendMessage({
      seed: seed
    }).then(data => callback(undefined, data)).catch(callback);
  }

  loadDistributedApp(seed, swConfig, callback) {
    var self = this;
    this.clearServiceWorkerInScope(swConfig.scope, (err, res) => {
      if (err) return callback(err);
      self.registerServiceWorker(swConfig, (err, sw) => {
        if (err) return callback(err);
        self.sendSeedToSW(seed, err => {
          callback(err ? new Error("Failed initialization... ".concat(err)) : undefined);
        });
      });
    });
  }

  addServiceWorkerEventListener(eventType, listener, options) {
    if (this.canUseServiceWorkers()) navigator.serviceWorker.addEventListener(eventType, listener, options);
  }

  canRegisterPWA() {
    return this.environment.pwa;
  }

  showNewContentAvailable() {
    return __awaiter(this, void 0, void 0, function* () {
      if (yield this.popUp.ask("New Content Is available. Click ok to install!")) window.location.reload();
    });
  }

  registerPwaServiceWorker() {
    if (!this.canRegisterPWA()) return console.log("This application does not support Progressive Web Applications");
    var self = this;
    this.getWebManifest((err, manifest) => {
      if (err || !manifest) return console.log(err || new Error("Missing Manifest file. Skipping PWA installation"));
      var {
        scope
      } = manifest;
      var wb = new _workboxWindow.Workbox('./swPa.js', {
        scope: scope
      });
      wb.register().then(registration => {
        if (!registration) throw new Error("Could not register Service Worker");
        registration.addEventListener(_constants.ServiceWorkerConstants.EVENTS.UPDATE, () => {
          console.log(_constants.ServiceWorkerConstants.EVENTS.UPDATE, {
            installing: registration.installing,
            active: registration.active
          });
          var activeWorker = registration.active;

          if (activeWorker) {
            activeWorker.addEventListener(_constants.ServiceWorkerConstants.EVENTS.STATE_CHANGE, () => {
              console.log("active statechange", activeWorker.state);

              if (activeWorker.state === _constants.ServiceWorkerConstants.STATE.INSTALLED && navigator.serviceWorker.controller) {
                self.showNewContentAvailable();
              }
            });
          }
        });
      }).catch(err => {
        console.error("Problem registering service worker", err);
      });
      setInterval(() => __awaiter(this, void 0, void 0, function* () {
        try {
          yield wb.update();
        } catch (e) {
          console.warn("Errors from service worker:", e);
        }
      }), 60 * 1000);
    });
  }

  unregisterAllServiceWorkers(callback) {
    var self = this;
    this.getRegistrations((err, registrations) => {
      if (err) return callback(err);
      if (!registrations.length) return callback();
      var unRegistrations = registrations.map(reg => {
        return new Promise(resolve => {
          return self.unregisterServiceWorker(reg, resolve);
        });
      });
      return Promise.all(unRegistrations).then(result => callback(undefined, result)).catch(callback);
    });
  }

}

exports.NavigatorUtils = NavigatorUtils;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZpY2VzL25hdmlnYXRvci5qcyJdLCJuYW1lcyI6WyJfX2F3YWl0ZXIiLCJ0aGlzQXJnIiwiX2FyZ3VtZW50cyIsIlAiLCJnZW5lcmF0b3IiLCJhZG9wdCIsInZhbHVlIiwicmVzb2x2ZSIsIlByb21pc2UiLCJyZWplY3QiLCJmdWxmaWxsZWQiLCJzdGVwIiwibmV4dCIsImUiLCJyZWplY3RlZCIsInJlc3VsdCIsImRvbmUiLCJ0aGVuIiwiYXBwbHkiLCJTZXJ2aWNlV29ya2VyRXJyb3IiLCJFcnJvciIsImNvbnN0cnVjdG9yIiwibWVzc2FnZSIsInR5cGUiLCJuYXZpZ2F0b3JVdGlscyIsImdldE5hdmlnYXRvclV0aWxzIiwiTmF2aWdhdG9yVXRpbHMiLCJlbnZpcm9ubWVudCIsInNwaW5uZXIiLCJwb3BVcCIsImNvbnRyb2xsZXJzQ2hhbmdlSGFuZGxlcnMiLCJ3ZWJNYW5pZmVzdCIsInVuZGVmaW5lZCIsImdldFJlZ2lzdHJhdGlvbnMiLCJjYWxsYmFjayIsImFyZVNlcnZpY2VXb3JrZXJzU3VwcG9ydGVkIiwibmF2aWdhdG9yIiwic2VydmljZVdvcmtlciIsInJlZ2lzdHJhdGlvbnMiLCJjYXRjaCIsImFyZVNlcnZpY2VXb3JrZXJzRW5hYmxlZCIsInN3IiwiY2FuVXNlU2VydmljZVdvcmtlcnMiLCJvblNlcnZpY2VXb3JrZXJSZWFkeSIsIm5hbWUiLCJyZWdpc3RyYXRpb24iLCJpbnN0YWxsaW5nIiwib25lcnJvciIsImVyciIsImNvbnNvbGUiLCJlcnJvciIsImFkZEV2ZW50TGlzdGVuZXIiLCJyZXMiLCJzdGF0ZSIsImxvZyIsInB1c2giLCJzd05hbWUiLCJyZWdpc3RlclNlcnZpY2VXb3JrZXIiLCJvcHRpb25zIiwic2NvcGUiLCJzZWxmIiwicGF0aCIsIkpTT04iLCJzdHJpbmdpZnkiLCJyZWdpc3RlciIsImFjdGl2ZSIsInVucmVnaXN0ZXJTZXJ2aWNlV29ya2VyIiwidW5yZWdpc3RlciIsImltbWVkaWF0ZSIsInN1Y2Nlc3MiLCJnZXRXZWJNYW5pZmVzdCIsImZldGNoIiwiTG9hZGVyQ29uc3RhbnRzIiwiTUFOSUZFU1RfRklMRSIsInJlc3BvbnNlIiwianNvbiIsIm1hbmlmZXN0IiwiY2xlYXJTZXJ2aWNlV29ya2VySW5TY29wZSIsImdldFJlZ2lzdHJhdGlvbiIsInNlbmRNZXNzYWdlIiwibWVzc2FnZUNoYW5uZWwiLCJNZXNzYWdlQ2hhbm5lbCIsInBvcnQxIiwib25tZXNzYWdlIiwiZXZlbnQiLCJkYXRhIiwiY29udHJvbGxlciIsInBvc3RNZXNzYWdlIiwicG9ydDIiLCJvbmNvbnRyb2xsZXJjaGFuZ2UiLCJzZW5kU2VlZFRvU1ciLCJzZWVkIiwibG9hZERpc3RyaWJ1dGVkQXBwIiwic3dDb25maWciLCJhZGRTZXJ2aWNlV29ya2VyRXZlbnRMaXN0ZW5lciIsImV2ZW50VHlwZSIsImxpc3RlbmVyIiwiY2FuUmVnaXN0ZXJQV0EiLCJwd2EiLCJzaG93TmV3Q29udGVudEF2YWlsYWJsZSIsImFzayIsIndpbmRvdyIsImxvY2F0aW9uIiwicmVsb2FkIiwicmVnaXN0ZXJQd2FTZXJ2aWNlV29ya2VyIiwid2IiLCJXb3JrYm94IiwiU2VydmljZVdvcmtlckNvbnN0YW50cyIsIkVWRU5UUyIsIlVQREFURSIsImFjdGl2ZVdvcmtlciIsIlNUQVRFX0NIQU5HRSIsIlNUQVRFIiwiSU5TVEFMTEVEIiwic2V0SW50ZXJ2YWwiLCJ1cGRhdGUiLCJ3YXJuIiwidW5yZWdpc3RlckFsbFNlcnZpY2VXb3JrZXJzIiwibGVuZ3RoIiwidW5SZWdpc3RyYXRpb25zIiwibWFwIiwicmVnIiwiYWxsIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQVNBOztBQUNBOztBQVZBLElBQUlBLFNBQVMsR0FBSSxVQUFRLFNBQUtBLFNBQWQsSUFBNEIsVUFBVUMsT0FBVixFQUFtQkMsVUFBbkIsRUFBK0JDLENBQS9CLEVBQWtDQyxTQUFsQyxFQUE2QztBQUNyRixXQUFTQyxLQUFULENBQWVDLEtBQWYsRUFBc0I7QUFBRSxXQUFPQSxLQUFLLFlBQVlILENBQWpCLEdBQXFCRyxLQUFyQixHQUE2QixJQUFJSCxDQUFKLENBQU0sVUFBVUksT0FBVixFQUFtQjtBQUFFQSxNQUFBQSxPQUFPLENBQUNELEtBQUQsQ0FBUDtBQUFpQixLQUE1QyxDQUFwQztBQUFvRjs7QUFDNUcsU0FBTyxLQUFLSCxDQUFDLEtBQUtBLENBQUMsR0FBR0ssT0FBVCxDQUFOLEVBQXlCLFVBQVVELE9BQVYsRUFBbUJFLE1BQW5CLEVBQTJCO0FBQ3ZELGFBQVNDLFNBQVQsQ0FBbUJKLEtBQW5CLEVBQTBCO0FBQUUsVUFBSTtBQUFFSyxRQUFBQSxJQUFJLENBQUNQLFNBQVMsQ0FBQ1EsSUFBVixDQUFlTixLQUFmLENBQUQsQ0FBSjtBQUE4QixPQUFwQyxDQUFxQyxPQUFPTyxDQUFQLEVBQVU7QUFBRUosUUFBQUEsTUFBTSxDQUFDSSxDQUFELENBQU47QUFBWTtBQUFFOztBQUMzRixhQUFTQyxRQUFULENBQWtCUixLQUFsQixFQUF5QjtBQUFFLFVBQUk7QUFBRUssUUFBQUEsSUFBSSxDQUFDUCxTQUFTLENBQUMsT0FBRCxDQUFULENBQW1CRSxLQUFuQixDQUFELENBQUo7QUFBa0MsT0FBeEMsQ0FBeUMsT0FBT08sQ0FBUCxFQUFVO0FBQUVKLFFBQUFBLE1BQU0sQ0FBQ0ksQ0FBRCxDQUFOO0FBQVk7QUFBRTs7QUFDOUYsYUFBU0YsSUFBVCxDQUFjSSxNQUFkLEVBQXNCO0FBQUVBLE1BQUFBLE1BQU0sQ0FBQ0MsSUFBUCxHQUFjVCxPQUFPLENBQUNRLE1BQU0sQ0FBQ1QsS0FBUixDQUFyQixHQUFzQ0QsS0FBSyxDQUFDVSxNQUFNLENBQUNULEtBQVIsQ0FBTCxDQUFvQlcsSUFBcEIsQ0FBeUJQLFNBQXpCLEVBQW9DSSxRQUFwQyxDQUF0QztBQUFzRjs7QUFDOUdILElBQUFBLElBQUksQ0FBQyxDQUFDUCxTQUFTLEdBQUdBLFNBQVMsQ0FBQ2MsS0FBVixDQUFnQmpCLE9BQWhCLEVBQXlCQyxVQUFVLElBQUksRUFBdkMsQ0FBYixFQUF5RFUsSUFBekQsRUFBRCxDQUFKO0FBQ0gsR0FMTSxDQUFQO0FBTUgsQ0FSRDs7QUFXTyxNQUFNTyxrQkFBTixTQUFpQ0MsS0FBakMsQ0FBdUM7QUFDMUNDLEVBQUFBLFdBQVcsQ0FBQ0MsT0FBRCxFQUFVO0FBQ2pCLFVBQU0sT0FBT0EsT0FBUCxLQUFtQixRQUFuQixHQUE4QkEsT0FBOUIsR0FBd0NBLE9BQU8sQ0FBQ0EsT0FBdEQ7QUFDQSxTQUFLQyxJQUFMLEdBQVksb0JBQVo7QUFDSDs7QUFKeUM7OztBQU05QyxJQUFJQyxjQUFKOztBQUNPLFNBQVNDLGlCQUFULEdBQTZCO0FBQ2hDLFNBQU9ELGNBQVA7QUFDSDs7QUFDTSxNQUFNRSxjQUFOLENBQXFCO0FBQ3hCTCxFQUFBQSxXQUFXLENBQUNNLFdBQUQsRUFBY0MsT0FBZCxFQUF1QkMsS0FBdkIsRUFBOEI7QUFDckMsU0FBS0MseUJBQUwsR0FBaUMsRUFBakM7QUFDQSxTQUFLQyxXQUFMLEdBQW1CQyxTQUFuQjtBQUNBLFNBQUtMLFdBQUwsR0FBbUJBLFdBQW5CO0FBQ0EsU0FBS0MsT0FBTCxHQUFlQSxPQUFmO0FBQ0EsU0FBS0MsS0FBTCxHQUFhQSxLQUFiO0FBQ0FMLElBQUFBLGNBQWMsR0FBRyxJQUFqQjtBQUNIOztBQUNEUyxFQUFBQSxnQkFBZ0IsQ0FBQ0MsUUFBRCxFQUFXO0FBQ3ZCLFFBQUksS0FBS0MsMEJBQUwsRUFBSixFQUNJLE9BQU9DLFNBQVMsQ0FBQ0MsYUFBVixDQUF3QkosZ0JBQXhCLEdBQTJDaEIsSUFBM0MsQ0FBZ0RxQixhQUFhLElBQUk7QUFDcEVKLE1BQUFBLFFBQVEsQ0FBQ0YsU0FBRCxFQUFZTSxhQUFaLENBQVI7QUFDSCxLQUZNLEVBRUpDLEtBRkksQ0FFRTFCLENBQUMsSUFBSTtBQUNWcUIsTUFBQUEsUUFBUSxDQUFDLElBQUlmLGtCQUFKLENBQXVCLHlFQUF2QixDQUFELENBQVI7QUFDSCxLQUpNLENBQVA7QUFLSixRQUFJLEtBQUtxQix3QkFBTCxFQUFKLEVBQ0ksT0FBT04sUUFBUSxDQUFDLElBQUlmLGtCQUFKLENBQXVCLG9EQUF2QixDQUFELENBQWY7QUFDSmUsSUFBQUEsUUFBUSxDQUFDRixTQUFELEVBQVksRUFBWixDQUFSO0FBQ0g7O0FBQ0RHLEVBQUFBLDBCQUEwQixHQUFHO0FBQ3pCLFdBQU8sbUJBQW1CQyxTQUExQjtBQUNIOztBQUNESSxFQUFBQSx3QkFBd0IsR0FBRztBQUN2QixXQUFPLEtBQUtiLFdBQUwsQ0FBaUJjLEVBQXhCO0FBQ0g7O0FBQ0RDLEVBQUFBLG9CQUFvQixHQUFHO0FBQ25CLFdBQU8sS0FBS0Ysd0JBQUwsTUFBbUMsS0FBS0wsMEJBQUwsRUFBMUM7QUFDSDs7QUFDRFEsRUFBQUEsb0JBQW9CLENBQUNDLElBQUQsRUFBT0MsWUFBUCxFQUFxQlgsUUFBckIsRUFBK0I7QUFDL0MsUUFBTTtBQUFFWSxNQUFBQTtBQUFGLFFBQWlCRCxZQUF2Qjs7QUFDQSxRQUFJQyxVQUFKLEVBQWdCO0FBQ1pBLE1BQUFBLFVBQVUsQ0FBQ0MsT0FBWCxHQUFxQixVQUFVQyxHQUFWLEVBQWU7QUFDaENDLFFBQUFBLE9BQU8sQ0FBQ0MsS0FBUixDQUFjRixHQUFkO0FBQ0gsT0FGRDs7QUFHQUYsTUFBQUEsVUFBVSxDQUFDSyxnQkFBWCxDQUE0QixhQUE1QixFQUE0Q0MsR0FBRCxJQUFTO0FBQ2hELFlBQUlOLFVBQVUsQ0FBQ08sS0FBWCxLQUFxQixXQUF6QixFQUFzQztBQUNsQ25CLFVBQUFBLFFBQVEsQ0FBQ0YsU0FBRCxFQUFZYSxZQUFaLENBQVI7QUFDSDs7QUFDREksUUFBQUEsT0FBTyxDQUFDSyxHQUFSLENBQVksVUFBWixFQUF3QlIsVUFBVSxDQUFDTyxLQUFuQztBQUNILE9BTEQ7QUFNSCxLQVZELE1BV0s7QUFDRCxXQUFLdkIseUJBQUwsQ0FBK0J5QixJQUEvQixDQUFvQztBQUNoQ0MsUUFBQUEsTUFBTSxFQUFFWixJQUR3QjtBQUVoQ0MsUUFBQUEsWUFBWSxFQUFFQSxZQUZrQjtBQUdoQ1gsUUFBQUEsUUFBUSxFQUFFQTtBQUhzQixPQUFwQztBQUtIO0FBQ0o7O0FBQ0R1QixFQUFBQSxxQkFBcUIsQ0FBQ0MsT0FBRCxFQUFVeEIsUUFBVixFQUFvQjtBQUNyQyxRQUFNO0FBQUV5QixNQUFBQTtBQUFGLFFBQVlELE9BQWxCO0FBQ0EsUUFBTUUsSUFBSSxHQUFHLElBQWI7O0FBQ0EsUUFBSSxLQUFLekIsMEJBQUwsRUFBSixFQUF1QztBQUNuQ2MsTUFBQUEsT0FBTyxDQUFDSyxHQUFSLENBQVksY0FBWixFQUE0QkksT0FBTyxDQUFDRyxJQUFwQyxFQUEwQ0MsSUFBSSxDQUFDQyxTQUFMLENBQWVKLEtBQWYsQ0FBMUM7QUFDQXZCLE1BQUFBLFNBQVMsQ0FBQ0MsYUFBVixDQUNLMkIsUUFETCxDQUNjTixPQUFPLENBQUNHLElBRHRCLEVBQzRCRixLQUQ1QixFQUVLMUMsSUFGTCxDQUVXNEIsWUFBRCxJQUFrQjtBQUN4QixZQUFJQSxZQUFZLENBQUNvQixNQUFqQixFQUF5QjtBQUNyQixpQkFBTy9CLFFBQVEsQ0FBQ0YsU0FBRCxFQUFZYSxZQUFaLENBQWY7QUFDSDs7QUFDREEsUUFBQUEsWUFBWSxDQUFDRSxPQUFiLEdBQXVCLFVBQVVDLEdBQVYsRUFBZTtBQUNsQ0MsVUFBQUEsT0FBTyxDQUFDQyxLQUFSLHVDQUFvREYsR0FBcEQ7QUFDSCxTQUZEOztBQUdBWSxRQUFBQSxJQUFJLENBQUNqQixvQkFBTCxDQUEwQmUsT0FBTyxDQUFDZCxJQUFsQyxFQUF3Q0MsWUFBeEMsRUFBc0RYLFFBQXREO0FBQ0gsT0FWRCxFQVVJYyxHQUFELElBQVM7QUFDUkMsUUFBQUEsT0FBTyxDQUFDQyxLQUFSLENBQWNGLEdBQWQ7QUFDSCxPQVpELEVBYUtULEtBYkwsQ0FhWVMsR0FBRCxJQUFTO0FBQ2hCQyxRQUFBQSxPQUFPLENBQUNDLEtBQVIsQ0FBY0YsR0FBZDtBQUNBLGVBQU9kLFFBQVEsQ0FBQyxJQUFJZCxLQUFKLENBQVUscUNBQVYsQ0FBRCxDQUFmO0FBQ0gsT0FoQkQ7QUFpQkg7QUFDSjs7QUFDRDhDLEVBQUFBLHVCQUF1QixDQUFDekIsRUFBRCxFQUFLUCxRQUFMLEVBQWU7QUFDbENPLElBQUFBLEVBQUUsQ0FBQzBCLFVBQUgsQ0FBYztBQUFFQyxNQUFBQSxTQUFTLEVBQUU7QUFBYixLQUFkLEVBQW1DbkQsSUFBbkMsQ0FBeUNvRCxPQUFELElBQWE7QUFDakQsVUFBSSxDQUFDQSxPQUFMLEVBQWM7QUFDVnBCLFFBQUFBLE9BQU8sQ0FBQ0ssR0FBUixDQUFZLDBCQUFaLEVBQXdDYixFQUF4QztBQUNBLGVBQU9QLFFBQVEsQ0FBQyxJQUFJZCxLQUFKLENBQVUseUJBQVYsQ0FBRCxDQUFmO0FBQ0g7O0FBQ0RjLE1BQUFBLFFBQVE7QUFDWCxLQU5ELEVBTUdLLEtBTkgsQ0FNU0wsUUFOVDtBQU9IOztBQUNEb0MsRUFBQUEsY0FBYyxDQUFDcEMsUUFBRCxFQUFXO0FBQ3JCLFFBQUksS0FBS0gsV0FBVCxFQUNJLE9BQU9HLFFBQVEsQ0FBQ0YsU0FBRCxFQUFZLEtBQUtELFdBQWpCLENBQWY7QUFDSixRQUFNNkIsSUFBSSxHQUFHLElBQWI7QUFDQVcsSUFBQUEsS0FBSyxDQUFDQywyQkFBZ0JDLGFBQWpCLENBQUwsQ0FDS3hELElBREwsQ0FDV3lELFFBQUQsSUFBY0EsUUFBUSxDQUFDQyxJQUFULEVBRHhCLEVBRUsxRCxJQUZMLENBRVcyRCxRQUFELElBQWM7QUFDcEJoQixNQUFBQSxJQUFJLENBQUM3QixXQUFMLEdBQW1CNkMsUUFBbkI7QUFDQTFDLE1BQUFBLFFBQVEsQ0FBQ0YsU0FBRCxFQUFZNEMsUUFBWixDQUFSO0FBQ0gsS0FMRCxFQU1LckMsS0FOTCxDQU1ZUyxHQUFELElBQVM7QUFDaEJDLE1BQUFBLE9BQU8sQ0FBQ0MsS0FBUix3Q0FBOENzQiwyQkFBZ0JDLGFBQTlELEdBQStFekIsR0FBL0U7QUFDQWQsTUFBQUEsUUFBUTtBQUNYLEtBVEQ7QUFVSDs7QUFDRDJDLEVBQUFBLHlCQUF5QixDQUFDbEIsS0FBRCxFQUFRekIsUUFBUixFQUFrQjtBQUN2QyxRQUFJLEtBQUtDLDBCQUFMLEVBQUosRUFDSUMsU0FBUyxDQUFDQyxhQUFWLENBQXdCeUMsZUFBeEIsQ0FBd0NuQixLQUF4QyxFQUNLMUMsSUFETCxDQUNXd0IsRUFBRCxJQUFRO0FBQ2QsVUFBSSxDQUFDQSxFQUFMLEVBQ0ksT0FBT1AsUUFBUSxDQUFDLElBQUlkLEtBQUosNkNBQStDdUMsS0FBL0MsRUFBRCxDQUFmOztBQUNKLFVBQUlBLEtBQUssS0FBS2xCLEVBQUUsQ0FBQ2tCLEtBQWpCLEVBQXdCO0FBQ3BCVixRQUFBQSxPQUFPLENBQUNLLEdBQVIsOENBQWtESyxLQUFsRDtBQUNBLGVBQU8sS0FBS08sdUJBQUwsQ0FBNkJ6QixFQUE3QixFQUFpQ1AsUUFBakMsQ0FBUDtBQUNILE9BSEQsTUFJSztBQUNEQSxRQUFBQSxRQUFRO0FBQ1g7QUFDSixLQVhELEVBV0dLLEtBWEgsQ0FXU0wsUUFYVDtBQVlQOztBQUNENkMsRUFBQUEsV0FBVyxDQUFDekQsT0FBRCxFQUFVO0FBQ2pCLFdBQU8sSUFBSWQsT0FBSixDQUFZLFVBQVVELE9BQVYsRUFBbUJFLE1BQW5CLEVBQTJCO0FBQzFDLFVBQU11RSxjQUFjLEdBQUcsSUFBSUMsY0FBSixFQUF2Qjs7QUFDQUQsTUFBQUEsY0FBYyxDQUFDRSxLQUFmLENBQXFCQyxTQUFyQixHQUFpQyxVQUFVQyxLQUFWLEVBQWlCO0FBQzlDLFlBQUlBLEtBQUssQ0FBQ0MsSUFBTixDQUFXbkMsS0FBZixFQUFzQjtBQUNsQnpDLFVBQUFBLE1BQU0sQ0FBQzJFLEtBQUssQ0FBQ0MsSUFBTixDQUFXbkMsS0FBWixDQUFOO0FBQ0gsU0FGRCxNQUdLO0FBQ0QzQyxVQUFBQSxPQUFPLENBQUM2RSxLQUFLLENBQUNDLElBQVAsQ0FBUDtBQUNIO0FBQ0osT0FQRDs7QUFRQSxVQUFJakQsU0FBUyxDQUFDQyxhQUFWLENBQXdCaUQsVUFBNUIsRUFBd0M7QUFDcENsRCxRQUFBQSxTQUFTLENBQUNDLGFBQVYsQ0FBd0JpRCxVQUF4QixDQUFtQ0MsV0FBbkMsQ0FBK0NqRSxPQUEvQyxFQUF3RCxDQUFDMEQsY0FBYyxDQUFDUSxLQUFoQixDQUF4RDtBQUNILE9BRkQsTUFHSztBQUNEcEQsUUFBQUEsU0FBUyxDQUFDQyxhQUFWLENBQXdCb0Qsa0JBQXhCLEdBQTZDLFlBQVk7QUFDckQsY0FBSXJELFNBQVMsQ0FBQ0MsYUFBVixDQUF3QmlELFVBQTVCLEVBQ0lsRCxTQUFTLENBQUNDLGFBQVYsQ0FBd0JpRCxVQUF4QixDQUFtQ0MsV0FBbkMsQ0FBK0NqRSxPQUEvQyxFQUF3RCxDQUFDMEQsY0FBYyxDQUFDUSxLQUFoQixDQUF4RDtBQUNQLFNBSEQ7QUFJSDtBQUNKLEtBbkJNLENBQVA7QUFvQkg7O0FBQ0RFLEVBQUFBLFlBQVksQ0FBQ0MsSUFBRCxFQUFPekQsUUFBUCxFQUFpQjtBQUN6QixTQUFLNkMsV0FBTCxDQUFpQjtBQUFFWSxNQUFBQSxJQUFJLEVBQUVBO0FBQVIsS0FBakIsRUFDSzFFLElBREwsQ0FDV29FLElBQUQsSUFBVW5ELFFBQVEsQ0FBQ0YsU0FBRCxFQUFZcUQsSUFBWixDQUQ1QixFQUVLOUMsS0FGTCxDQUVXTCxRQUZYO0FBR0g7O0FBQ0QwRCxFQUFBQSxrQkFBa0IsQ0FBQ0QsSUFBRCxFQUFPRSxRQUFQLEVBQWlCM0QsUUFBakIsRUFBMkI7QUFDekMsUUFBTTBCLElBQUksR0FBRyxJQUFiO0FBQ0EsU0FBS2lCLHlCQUFMLENBQStCZ0IsUUFBUSxDQUFDbEMsS0FBeEMsRUFBK0MsQ0FBQ1gsR0FBRCxFQUFNSSxHQUFOLEtBQWM7QUFDekQsVUFBSUosR0FBSixFQUNJLE9BQU9kLFFBQVEsQ0FBQ2MsR0FBRCxDQUFmO0FBQ0pZLE1BQUFBLElBQUksQ0FBQ0gscUJBQUwsQ0FBMkJvQyxRQUEzQixFQUFxQyxDQUFDN0MsR0FBRCxFQUFNUCxFQUFOLEtBQWE7QUFDOUMsWUFBSU8sR0FBSixFQUNJLE9BQU9kLFFBQVEsQ0FBQ2MsR0FBRCxDQUFmO0FBQ0pZLFFBQUFBLElBQUksQ0FBQzhCLFlBQUwsQ0FBa0JDLElBQWxCLEVBQXlCM0MsR0FBRCxJQUFTO0FBQzdCZCxVQUFBQSxRQUFRLENBQUNjLEdBQUcsR0FBRyxJQUFJNUIsS0FBSixvQ0FBc0M0QixHQUF0QyxFQUFILEdBQWtEaEIsU0FBdEQsQ0FBUjtBQUNILFNBRkQ7QUFHSCxPQU5EO0FBT0gsS0FWRDtBQVdIOztBQUNEOEQsRUFBQUEsNkJBQTZCLENBQUNDLFNBQUQsRUFBWUMsUUFBWixFQUFzQnRDLE9BQXRCLEVBQStCO0FBQ3hELFFBQUksS0FBS2hCLG9CQUFMLEVBQUosRUFDSU4sU0FBUyxDQUFDQyxhQUFWLENBQXdCYyxnQkFBeEIsQ0FBeUM0QyxTQUF6QyxFQUFvREMsUUFBcEQsRUFBOER0QyxPQUE5RDtBQUNQOztBQUNEdUMsRUFBQUEsY0FBYyxHQUFHO0FBQ2IsV0FBTyxLQUFLdEUsV0FBTCxDQUFpQnVFLEdBQXhCO0FBQ0g7O0FBQ0RDLEVBQUFBLHVCQUF1QixHQUFHO0FBQ3RCLFdBQU9uRyxTQUFTLENBQUMsSUFBRCxFQUFPLEtBQUssQ0FBWixFQUFlLEtBQUssQ0FBcEIsRUFBdUIsYUFBYTtBQUNoRCxVQUFJLE1BQU0sS0FBSzZCLEtBQUwsQ0FBV3VFLEdBQVgsa0RBQVYsRUFDSUMsTUFBTSxDQUFDQyxRQUFQLENBQWdCQyxNQUFoQjtBQUNQLEtBSGUsQ0FBaEI7QUFJSDs7QUFDREMsRUFBQUEsd0JBQXdCLEdBQUc7QUFDdkIsUUFBSSxDQUFDLEtBQUtQLGNBQUwsRUFBTCxFQUNJLE9BQU9oRCxPQUFPLENBQUNLLEdBQVIsa0VBQVA7QUFDSixRQUFNTSxJQUFJLEdBQUcsSUFBYjtBQUNBLFNBQUtVLGNBQUwsQ0FBb0IsQ0FBQ3RCLEdBQUQsRUFBTTRCLFFBQU4sS0FBbUI7QUFDbkMsVUFBSTVCLEdBQUcsSUFBSSxDQUFDNEIsUUFBWixFQUNJLE9BQU8zQixPQUFPLENBQUNLLEdBQVIsQ0FBWU4sR0FBRyxJQUFJLElBQUk1QixLQUFKLG9EQUFuQixDQUFQO0FBQ0osVUFBTTtBQUFFdUMsUUFBQUE7QUFBRixVQUFZaUIsUUFBbEI7QUFDQSxVQUFNNkIsRUFBRSxHQUFHLElBQUlDLHNCQUFKLENBQVksV0FBWixFQUF5QjtBQUFFL0MsUUFBQUEsS0FBSyxFQUFFQTtBQUFULE9BQXpCLENBQVg7QUFDQThDLE1BQUFBLEVBQUUsQ0FBQ3pDLFFBQUgsR0FBYy9DLElBQWQsQ0FBb0I0QixZQUFELElBQWtCO0FBQ2pDLFlBQUksQ0FBQ0EsWUFBTCxFQUNJLE1BQU0sSUFBSXpCLEtBQUoscUNBQU47QUFDSnlCLFFBQUFBLFlBQVksQ0FBQ00sZ0JBQWIsQ0FBOEJ3RCxrQ0FBdUJDLE1BQXZCLENBQThCQyxNQUE1RCxFQUFvRSxNQUFNO0FBQ3RFNUQsVUFBQUEsT0FBTyxDQUFDSyxHQUFSLENBQVlxRCxrQ0FBdUJDLE1BQXZCLENBQThCQyxNQUExQyxFQUFrRDtBQUM5Qy9ELFlBQUFBLFVBQVUsRUFBRUQsWUFBWSxDQUFDQyxVQURxQjtBQUU5Q21CLFlBQUFBLE1BQU0sRUFBRXBCLFlBQVksQ0FBQ29CO0FBRnlCLFdBQWxEO0FBSUEsY0FBTTZDLFlBQVksR0FBR2pFLFlBQVksQ0FBQ29CLE1BQWxDOztBQUNBLGNBQUk2QyxZQUFKLEVBQWtCO0FBQ2RBLFlBQUFBLFlBQVksQ0FBQzNELGdCQUFiLENBQThCd0Qsa0NBQXVCQyxNQUF2QixDQUE4QkcsWUFBNUQsRUFBMEUsTUFBTTtBQUM1RTlELGNBQUFBLE9BQU8sQ0FBQ0ssR0FBUixDQUFZLG9CQUFaLEVBQWtDd0QsWUFBWSxDQUFDekQsS0FBL0M7O0FBQ0Esa0JBQUl5RCxZQUFZLENBQUN6RCxLQUFiLEtBQXVCc0Qsa0NBQXVCSyxLQUF2QixDQUE2QkMsU0FBcEQsSUFBaUU3RSxTQUFTLENBQUNDLGFBQVYsQ0FBd0JpRCxVQUE3RixFQUF5RztBQUNyRzFCLGdCQUFBQSxJQUFJLENBQUN1Qyx1QkFBTDtBQUNIO0FBQ0osYUFMRDtBQU1IO0FBQ0osU0FkRDtBQWVILE9BbEJELEVBa0JHNUQsS0FsQkgsQ0FrQlNTLEdBQUcsSUFBSTtBQUNaQyxRQUFBQSxPQUFPLENBQUNDLEtBQVIsdUNBQW9ERixHQUFwRDtBQUNILE9BcEJEO0FBcUJBa0UsTUFBQUEsV0FBVyxDQUFDLE1BQU1sSCxTQUFTLENBQUMsSUFBRCxFQUFPLEtBQUssQ0FBWixFQUFlLEtBQUssQ0FBcEIsRUFBdUIsYUFBYTtBQUMzRCxZQUFJO0FBQ0EsZ0JBQU15RyxFQUFFLENBQUNVLE1BQUgsRUFBTjtBQUNILFNBRkQsQ0FHQSxPQUFPdEcsQ0FBUCxFQUFVO0FBQ05vQyxVQUFBQSxPQUFPLENBQUNtRSxJQUFSLGdDQUE0Q3ZHLENBQTVDO0FBQ0g7QUFDSixPQVAwQixDQUFoQixFQU9QLEtBQUssSUFQRSxDQUFYO0FBUUgsS0FsQ0Q7QUFtQ0g7O0FBQ0R3RyxFQUFBQSwyQkFBMkIsQ0FBQ25GLFFBQUQsRUFBVztBQUNsQyxRQUFNMEIsSUFBSSxHQUFHLElBQWI7QUFDQSxTQUFLM0IsZ0JBQUwsQ0FBc0IsQ0FBQ2UsR0FBRCxFQUFNVixhQUFOLEtBQXdCO0FBQzFDLFVBQUlVLEdBQUosRUFDSSxPQUFPZCxRQUFRLENBQUNjLEdBQUQsQ0FBZjtBQUNKLFVBQUksQ0FBQ1YsYUFBYSxDQUFDZ0YsTUFBbkIsRUFDSSxPQUFPcEYsUUFBUSxFQUFmO0FBQ0osVUFBTXFGLGVBQWUsR0FBR2pGLGFBQWEsQ0FBQ2tGLEdBQWQsQ0FBbUJDLEdBQUQsSUFBUztBQUMvQyxlQUFPLElBQUlqSCxPQUFKLENBQWFELE9BQUQsSUFBYTtBQUM1QixpQkFBT3FELElBQUksQ0FBQ00sdUJBQUwsQ0FBNkJ1RCxHQUE3QixFQUFrQ2xILE9BQWxDLENBQVA7QUFDSCxTQUZNLENBQVA7QUFHSCxPQUp1QixDQUF4QjtBQUtBLGFBQU9DLE9BQU8sQ0FBQ2tILEdBQVIsQ0FBWUgsZUFBWixFQUNGdEcsSUFERSxDQUNHRixNQUFNLElBQUltQixRQUFRLENBQUNGLFNBQUQsRUFBWWpCLE1BQVosQ0FEckIsRUFFRndCLEtBRkUsQ0FFSUwsUUFGSixDQUFQO0FBR0gsS0FiRDtBQWNIOztBQS9OdUIiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcbiAgICBmdW5jdGlvbiBhZG9wdCh2YWx1ZSkgeyByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBQID8gdmFsdWUgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHZhbHVlKTsgfSk7IH1cbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBhZG9wdChyZXN1bHQudmFsdWUpLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xuICAgIH0pO1xufTtcbmltcG9ydCB7IFdvcmtib3ggfSBmcm9tIFwid29ya2JveC13aW5kb3dcIjtcbmltcG9ydCB7IExvYWRlckNvbnN0YW50cywgU2VydmljZVdvcmtlckNvbnN0YW50cyB9IGZyb20gXCIuL2NvbnN0YW50c1wiO1xuZXhwb3J0IGNsYXNzIFNlcnZpY2VXb3JrZXJFcnJvciBleHRlbmRzIEVycm9yIHtcbiAgICBjb25zdHJ1Y3RvcihtZXNzYWdlKSB7XG4gICAgICAgIHN1cGVyKHR5cGVvZiBtZXNzYWdlID09PSAnc3RyaW5nJyA/IG1lc3NhZ2UgOiBtZXNzYWdlLm1lc3NhZ2UpO1xuICAgICAgICB0aGlzLnR5cGUgPSBcIlNlcnZpY2VXb3JrZXJFcnJvclwiO1xuICAgIH1cbn1cbmxldCBuYXZpZ2F0b3JVdGlscztcbmV4cG9ydCBmdW5jdGlvbiBnZXROYXZpZ2F0b3JVdGlscygpIHtcbiAgICByZXR1cm4gbmF2aWdhdG9yVXRpbHM7XG59XG5leHBvcnQgY2xhc3MgTmF2aWdhdG9yVXRpbHMge1xuICAgIGNvbnN0cnVjdG9yKGVudmlyb25tZW50LCBzcGlubmVyLCBwb3BVcCkge1xuICAgICAgICB0aGlzLmNvbnRyb2xsZXJzQ2hhbmdlSGFuZGxlcnMgPSBbXTtcbiAgICAgICAgdGhpcy53ZWJNYW5pZmVzdCA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5lbnZpcm9ubWVudCA9IGVudmlyb25tZW50O1xuICAgICAgICB0aGlzLnNwaW5uZXIgPSBzcGlubmVyO1xuICAgICAgICB0aGlzLnBvcFVwID0gcG9wVXA7XG4gICAgICAgIG5hdmlnYXRvclV0aWxzID0gdGhpcztcbiAgICB9XG4gICAgZ2V0UmVnaXN0cmF0aW9ucyhjYWxsYmFjaykge1xuICAgICAgICBpZiAodGhpcy5hcmVTZXJ2aWNlV29ya2Vyc1N1cHBvcnRlZCgpKVxuICAgICAgICAgICAgcmV0dXJuIG5hdmlnYXRvci5zZXJ2aWNlV29ya2VyLmdldFJlZ2lzdHJhdGlvbnMoKS50aGVuKHJlZ2lzdHJhdGlvbnMgPT4ge1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKHVuZGVmaW5lZCwgcmVnaXN0cmF0aW9ucyk7XG4gICAgICAgICAgICB9KS5jYXRjaChlID0+IHtcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhuZXcgU2VydmljZVdvcmtlckVycm9yKFwiU2VydmljZSBXb3JrZXJzIGFyZSBub3Qgc3VwcG9ydGVkIG9yIGFyZSByZXN0cmljdGVkIGJ5IGJyb3dzZXIgc2V0dGluZ3NcIikpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIGlmICh0aGlzLmFyZVNlcnZpY2VXb3JrZXJzRW5hYmxlZCgpKVxuICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG5ldyBTZXJ2aWNlV29ya2VyRXJyb3IoXCJTZXJ2aWNlIFdvcmtlcnMgYXJlIG5vdCBzdXBwb3J0ZWQgZm9yIHRoaXMgYnJvd3NlclwiKSk7XG4gICAgICAgIGNhbGxiYWNrKHVuZGVmaW5lZCwgW10pO1xuICAgIH1cbiAgICBhcmVTZXJ2aWNlV29ya2Vyc1N1cHBvcnRlZCgpIHtcbiAgICAgICAgcmV0dXJuIFwic2VydmljZVdvcmtlclwiIGluIG5hdmlnYXRvcjtcbiAgICB9XG4gICAgYXJlU2VydmljZVdvcmtlcnNFbmFibGVkKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5lbnZpcm9ubWVudC5zdztcbiAgICB9XG4gICAgY2FuVXNlU2VydmljZVdvcmtlcnMoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmFyZVNlcnZpY2VXb3JrZXJzRW5hYmxlZCgpICYmIHRoaXMuYXJlU2VydmljZVdvcmtlcnNTdXBwb3J0ZWQoKTtcbiAgICB9XG4gICAgb25TZXJ2aWNlV29ya2VyUmVhZHkobmFtZSwgcmVnaXN0cmF0aW9uLCBjYWxsYmFjaykge1xuICAgICAgICBjb25zdCB7IGluc3RhbGxpbmcgfSA9IHJlZ2lzdHJhdGlvbjtcbiAgICAgICAgaWYgKGluc3RhbGxpbmcpIHtcbiAgICAgICAgICAgIGluc3RhbGxpbmcub25lcnJvciA9IGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycik7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgaW5zdGFsbGluZy5hZGRFdmVudExpc3RlbmVyKFwic3RhdGVjaGFuZ2VcIiwgKHJlcykgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChpbnN0YWxsaW5nLnN0YXRlID09PSBcImFjdGl2YXRlZFwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHVuZGVmaW5lZCwgcmVnaXN0cmF0aW9uKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJTdyBzdGF0ZVwiLCBpbnN0YWxsaW5nLnN0YXRlKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyc0NoYW5nZUhhbmRsZXJzLnB1c2goe1xuICAgICAgICAgICAgICAgIHN3TmFtZTogbmFtZSxcbiAgICAgICAgICAgICAgICByZWdpc3RyYXRpb246IHJlZ2lzdHJhdGlvbixcbiAgICAgICAgICAgICAgICBjYWxsYmFjazogY2FsbGJhY2tcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJlZ2lzdGVyU2VydmljZVdvcmtlcihvcHRpb25zLCBjYWxsYmFjaykge1xuICAgICAgICBjb25zdCB7IHNjb3BlIH0gPSBvcHRpb25zO1xuICAgICAgICBjb25zdCBzZWxmID0gdGhpcztcbiAgICAgICAgaWYgKHRoaXMuYXJlU2VydmljZVdvcmtlcnNTdXBwb3J0ZWQoKSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJTVyBSZWdpc3RlcjpcIiwgb3B0aW9ucy5wYXRoLCBKU09OLnN0cmluZ2lmeShzY29wZSkpO1xuICAgICAgICAgICAgbmF2aWdhdG9yLnNlcnZpY2VXb3JrZXJcbiAgICAgICAgICAgICAgICAucmVnaXN0ZXIob3B0aW9ucy5wYXRoLCBzY29wZSlcbiAgICAgICAgICAgICAgICAudGhlbigocmVnaXN0cmF0aW9uKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbi5hY3RpdmUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKHVuZGVmaW5lZCwgcmVnaXN0cmF0aW9uKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmVnaXN0cmF0aW9uLm9uZXJyb3IgPSBmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFNlcnZpY2UgV29ya2VyIFJlZ2lzdHJhdGlvbiBGYWlsZWRgLCBlcnIpO1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgc2VsZi5vblNlcnZpY2VXb3JrZXJSZWFkeShvcHRpb25zLm5hbWUsIHJlZ2lzdHJhdGlvbiwgY2FsbGJhY2spO1xuICAgICAgICAgICAgfSwgKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycik7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG5ldyBFcnJvcihcIlNlcnZpY2Ugd29ya2VyIHJlZ2lzdHJhdGlvbiBmYWlsZWQuXCIpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuICAgIHVucmVnaXN0ZXJTZXJ2aWNlV29ya2VyKHN3LCBjYWxsYmFjaykge1xuICAgICAgICBzdy51bnJlZ2lzdGVyKHsgaW1tZWRpYXRlOiB0cnVlIH0pLnRoZW4oKHN1Y2Nlc3MpID0+IHtcbiAgICAgICAgICAgIGlmICghc3VjY2Vzcykge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiQ291bGQgbm90IHVucmVnaXN0ZXIgc3cgXCIsIHN3KTtcbiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2sobmV3IEVycm9yKFwiQ291bGQgbm90IHVucmVnaXN0ZXIgc3dcIikpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2FsbGJhY2soKTtcbiAgICAgICAgfSkuY2F0Y2goY2FsbGJhY2spO1xuICAgIH1cbiAgICBnZXRXZWJNYW5pZmVzdChjYWxsYmFjaykge1xuICAgICAgICBpZiAodGhpcy53ZWJNYW5pZmVzdClcbiAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayh1bmRlZmluZWQsIHRoaXMud2ViTWFuaWZlc3QpO1xuICAgICAgICBjb25zdCBzZWxmID0gdGhpcztcbiAgICAgICAgZmV0Y2goTG9hZGVyQ29uc3RhbnRzLk1BTklGRVNUX0ZJTEUpXG4gICAgICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHJlc3BvbnNlLmpzb24oKSlcbiAgICAgICAgICAgIC50aGVuKChtYW5pZmVzdCkgPT4ge1xuICAgICAgICAgICAgc2VsZi53ZWJNYW5pZmVzdCA9IG1hbmlmZXN0O1xuICAgICAgICAgICAgY2FsbGJhY2sodW5kZWZpbmVkLCBtYW5pZmVzdCk7XG4gICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihgQ2Fubm90IGxvYWQgbWFuaWZlc3QgZmlsZSBhdCAke0xvYWRlckNvbnN0YW50cy5NQU5JRkVTVF9GSUxFfWAsIGVycik7XG4gICAgICAgICAgICBjYWxsYmFjaygpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgY2xlYXJTZXJ2aWNlV29ya2VySW5TY29wZShzY29wZSwgY2FsbGJhY2spIHtcbiAgICAgICAgaWYgKHRoaXMuYXJlU2VydmljZVdvcmtlcnNTdXBwb3J0ZWQoKSlcbiAgICAgICAgICAgIG5hdmlnYXRvci5zZXJ2aWNlV29ya2VyLmdldFJlZ2lzdHJhdGlvbihzY29wZSlcbiAgICAgICAgICAgICAgICAudGhlbigoc3cpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIXN3KVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2sobmV3IEVycm9yKGBObyBTZXJ2aWNlIHdvcmtlciBmb3VuZCBmb3Igc2NvcGUgJHtzY29wZX1gKSk7XG4gICAgICAgICAgICAgICAgaWYgKHNjb3BlID09PSBzdy5zY29wZSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgUmVmcmVzaGluZyBTZXJ2aWNlV29ya2VyIGZvciBzY29wZSAke3Njb3BlfWApO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy51bnJlZ2lzdGVyU2VydmljZVdvcmtlcihzdywgY2FsbGJhY2spO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KS5jYXRjaChjYWxsYmFjayk7XG4gICAgfVxuICAgIHNlbmRNZXNzYWdlKG1lc3NhZ2UpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2VDaGFubmVsID0gbmV3IE1lc3NhZ2VDaGFubmVsKCk7XG4gICAgICAgICAgICBtZXNzYWdlQ2hhbm5lbC5wb3J0MS5vbm1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgICAgICAgICAgICBpZiAoZXZlbnQuZGF0YS5lcnJvcikge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXZlbnQuZGF0YS5lcnJvcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGV2ZW50LmRhdGEpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBpZiAobmF2aWdhdG9yLnNlcnZpY2VXb3JrZXIuY29udHJvbGxlcikge1xuICAgICAgICAgICAgICAgIG5hdmlnYXRvci5zZXJ2aWNlV29ya2VyLmNvbnRyb2xsZXIucG9zdE1lc3NhZ2UobWVzc2FnZSwgW21lc3NhZ2VDaGFubmVsLnBvcnQyXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBuYXZpZ2F0b3Iuc2VydmljZVdvcmtlci5vbmNvbnRyb2xsZXJjaGFuZ2UgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChuYXZpZ2F0b3Iuc2VydmljZVdvcmtlci5jb250cm9sbGVyKVxuICAgICAgICAgICAgICAgICAgICAgICAgbmF2aWdhdG9yLnNlcnZpY2VXb3JrZXIuY29udHJvbGxlci5wb3N0TWVzc2FnZShtZXNzYWdlLCBbbWVzc2FnZUNoYW5uZWwucG9ydDJdKTtcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgc2VuZFNlZWRUb1NXKHNlZWQsIGNhbGxiYWNrKSB7XG4gICAgICAgIHRoaXMuc2VuZE1lc3NhZ2UoeyBzZWVkOiBzZWVkIH0pXG4gICAgICAgICAgICAudGhlbigoZGF0YSkgPT4gY2FsbGJhY2sodW5kZWZpbmVkLCBkYXRhKSlcbiAgICAgICAgICAgIC5jYXRjaChjYWxsYmFjayk7XG4gICAgfVxuICAgIGxvYWREaXN0cmlidXRlZEFwcChzZWVkLCBzd0NvbmZpZywgY2FsbGJhY2spIHtcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gICAgICAgIHRoaXMuY2xlYXJTZXJ2aWNlV29ya2VySW5TY29wZShzd0NvbmZpZy5zY29wZSwgKGVyciwgcmVzKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyKVxuICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhlcnIpO1xuICAgICAgICAgICAgc2VsZi5yZWdpc3RlclNlcnZpY2VXb3JrZXIoc3dDb25maWcsIChlcnIsIHN3KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGVycilcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycik7XG4gICAgICAgICAgICAgICAgc2VsZi5zZW5kU2VlZFRvU1coc2VlZCwgKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhlcnIgPyBuZXcgRXJyb3IoYEZhaWxlZCBpbml0aWFsaXphdGlvbi4uLiAke2Vycn1gKSA6IHVuZGVmaW5lZCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGFkZFNlcnZpY2VXb3JrZXJFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgbGlzdGVuZXIsIG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKHRoaXMuY2FuVXNlU2VydmljZVdvcmtlcnMoKSlcbiAgICAgICAgICAgIG5hdmlnYXRvci5zZXJ2aWNlV29ya2VyLmFkZEV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlLCBsaXN0ZW5lciwgb3B0aW9ucyk7XG4gICAgfVxuICAgIGNhblJlZ2lzdGVyUFdBKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5lbnZpcm9ubWVudC5wd2E7XG4gICAgfVxuICAgIHNob3dOZXdDb250ZW50QXZhaWxhYmxlKCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgaWYgKHlpZWxkIHRoaXMucG9wVXAuYXNrKGBOZXcgQ29udGVudCBJcyBhdmFpbGFibGUuIENsaWNrIG9rIHRvIGluc3RhbGwhYCkpXG4gICAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uLnJlbG9hZCgpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgcmVnaXN0ZXJQd2FTZXJ2aWNlV29ya2VyKCkge1xuICAgICAgICBpZiAoIXRoaXMuY2FuUmVnaXN0ZXJQV0EoKSlcbiAgICAgICAgICAgIHJldHVybiBjb25zb2xlLmxvZyhgVGhpcyBhcHBsaWNhdGlvbiBkb2VzIG5vdCBzdXBwb3J0IFByb2dyZXNzaXZlIFdlYiBBcHBsaWNhdGlvbnNgKTtcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gICAgICAgIHRoaXMuZ2V0V2ViTWFuaWZlc3QoKGVyciwgbWFuaWZlc3QpID0+IHtcbiAgICAgICAgICAgIGlmIChlcnIgfHwgIW1hbmlmZXN0KVxuICAgICAgICAgICAgICAgIHJldHVybiBjb25zb2xlLmxvZyhlcnIgfHwgbmV3IEVycm9yKGBNaXNzaW5nIE1hbmlmZXN0IGZpbGUuIFNraXBwaW5nIFBXQSBpbnN0YWxsYXRpb25gKSk7XG4gICAgICAgICAgICBjb25zdCB7IHNjb3BlIH0gPSBtYW5pZmVzdDtcbiAgICAgICAgICAgIGNvbnN0IHdiID0gbmV3IFdvcmtib3goJy4vc3dQYS5qcycsIHsgc2NvcGU6IHNjb3BlIH0pO1xuICAgICAgICAgICAgd2IucmVnaXN0ZXIoKS50aGVuKChyZWdpc3RyYXRpb24pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIXJlZ2lzdHJhdGlvbilcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgcmVnaXN0ZXIgU2VydmljZSBXb3JrZXJgKTtcbiAgICAgICAgICAgICAgICByZWdpc3RyYXRpb24uYWRkRXZlbnRMaXN0ZW5lcihTZXJ2aWNlV29ya2VyQ29uc3RhbnRzLkVWRU5UUy5VUERBVEUsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coU2VydmljZVdvcmtlckNvbnN0YW50cy5FVkVOVFMuVVBEQVRFLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpbnN0YWxsaW5nOiByZWdpc3RyYXRpb24uaW5zdGFsbGluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZTogcmVnaXN0cmF0aW9uLmFjdGl2ZSxcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGFjdGl2ZVdvcmtlciA9IHJlZ2lzdHJhdGlvbi5hY3RpdmU7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhY3RpdmVXb3JrZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZVdvcmtlci5hZGRFdmVudExpc3RlbmVyKFNlcnZpY2VXb3JrZXJDb25zdGFudHMuRVZFTlRTLlNUQVRFX0NIQU5HRSwgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiYWN0aXZlIHN0YXRlY2hhbmdlXCIsIGFjdGl2ZVdvcmtlci5zdGF0ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFjdGl2ZVdvcmtlci5zdGF0ZSA9PT0gU2VydmljZVdvcmtlckNvbnN0YW50cy5TVEFURS5JTlNUQUxMRUQgJiYgbmF2aWdhdG9yLnNlcnZpY2VXb3JrZXIuY29udHJvbGxlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNob3dOZXdDb250ZW50QXZhaWxhYmxlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgUHJvYmxlbSByZWdpc3RlcmluZyBzZXJ2aWNlIHdvcmtlcmAsIGVycik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHNldEludGVydmFsKCgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICB5aWVsZCB3Yi51cGRhdGUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKGBFcnJvcnMgZnJvbSBzZXJ2aWNlIHdvcmtlcjpgLCBlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KSwgNjAgKiAxMDAwKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHVucmVnaXN0ZXJBbGxTZXJ2aWNlV29ya2VycyhjYWxsYmFjaykge1xuICAgICAgICBjb25zdCBzZWxmID0gdGhpcztcbiAgICAgICAgdGhpcy5nZXRSZWdpc3RyYXRpb25zKChlcnIsIHJlZ2lzdHJhdGlvbnMpID0+IHtcbiAgICAgICAgICAgIGlmIChlcnIpXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycik7XG4gICAgICAgICAgICBpZiAoIXJlZ2lzdHJhdGlvbnMubGVuZ3RoKVxuICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjaygpO1xuICAgICAgICAgICAgY29uc3QgdW5SZWdpc3RyYXRpb25zID0gcmVnaXN0cmF0aW9ucy5tYXAoKHJlZykgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi51bnJlZ2lzdGVyU2VydmljZVdvcmtlcihyZWcsIHJlc29sdmUpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwodW5SZWdpc3RyYXRpb25zKVxuICAgICAgICAgICAgICAgIC50aGVuKHJlc3VsdCA9PiBjYWxsYmFjayh1bmRlZmluZWQsIHJlc3VsdCkpXG4gICAgICAgICAgICAgICAgLmNhdGNoKGNhbGxiYWNrKTtcbiAgICAgICAgfSk7XG4gICAgfVxufSJdLCJmaWxlIjoic2VydmljZXMvbmF2aWdhdG9yLmpzIn0=
