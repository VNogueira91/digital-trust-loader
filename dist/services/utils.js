"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.decrypt = decrypt;
exports.encrypt = encrypt;
exports.generateRandom = generateRandom;
exports.getLoginByMode = getLoginByMode;
exports.runInAutoLogin = runInAutoLogin;

var _types = require("../types");

var _constants = require("./constants");

function encrypt(key, dataObj) {
  try {
    var crypto = require('opendsu').loadApi('crypto');

    var encryptionKey = crypto.deriveEncryptionKey(key);
    var encryptedCredentials = crypto.encrypt(JSON.stringify(dataObj), encryptionKey);
    return JSON.stringify(encryptedCredentials);
  } catch (e) {
    throw e;
  }
}

function decrypt(key, dataObj) {
  try {
    var crypto = require('opendsu').loadApi('crypto');

    var encryptionKey = crypto.deriveEncryptionKey(key);
    var decryptData = crypto.decrypt($$.Buffer.from(JSON.parse(dataObj)), encryptionKey);
    return JSON.parse(decryptData.toString());
  } catch (e) {
    throw e;
  }
}

function generateRandom(charactersSet, length) {
  var result = '';
  var charactersLength = charactersSet.length;

  for (var i = 0; i < length; i++) {
    result += charactersSet.charAt(Math.floor(Math.random() * charactersLength));
  }

  return result;
}

var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';

function getSecretLocalToken(storage, development, mobile, storageKey) {
  if (mobile) return "SuperUserSecurePassword1!";
  if (typeof storageKey === "undefined") storageKey = "secretToken";
  if (development) return generateRandom(characters, 32);
  var secret = storage.getItem(storageKey);

  if (!secret) {
    secret = generateRandom(characters, 32);
    storage.setItem(storageKey, secret);
  }

  return secret;
}

function runInAutoLogin(credentials, config, storage, credentialsManager, walletService, development, mobile, callback) {
  credentials = [getSecretLocalToken(storage, development, mobile)];
  walletService.create(credentials, (err, wallet) => {
    if (err) return callback(err);
    if (!development) credentialsManager.saveCredentials(config.defaultPin, credentials);
    wallet.writeFile(_constants.LoaderConstants.USER_DETAILS_FILE, JSON.stringify(credentials), err => {
      if (err) return callback(err);
      console.log("A new wallet got initialised...", wallet.getCreationSSI(true));
      callback();
    });
  });
}

function getLoginByMode(environment, config, credentialsManager, storage) {
  switch (environment.mode) {
    case _types.LoaderMode.EXTERNAL_AUTO:
      return (credentials, walletService, spinner, callback) => {
        try {
          if (!config.defaultPin) return callback(new Error("Missing a default pin"));
          credentials = Object.values(credentialsManager.loadCredentials(config.defaultPin));
        } catch (e) {
          return callback(e);
        }

        walletService.create(credentials, (err, wallet) => {
          if (err) return callback(err);
          console.log("A new wallet got initialised...", wallet.getCreationSSI(true));
          callback(undefined, wallet);
        });
      };

    case _types.LoaderMode.DEV_AUTO:
      return (credentials, walletService, spinner, callback) => {
        runInAutoLogin(credentials, config, storage, credentialsManager, walletService, true, false, callback);
      };

    case _types.LoaderMode.MOBILE_AUTO:
      return (credentials, walletService, spinner, callback) => {
        runInAutoLogin(credentials, config, storage, credentialsManager, walletService, false, true, callback);
      };

    case _types.LoaderMode.AUTO:
      return (credentials, walletService, spinner, callback) => {
        runInAutoLogin(credentials, config, storage, credentialsManager, walletService, false, false, callback);
      };

    case _types.LoaderMode.DEV_SECURE:
    case _types.LoaderMode.SECURE:
    default:
      return undefined;
  }
}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZpY2VzL3V0aWxzLmpzIl0sIm5hbWVzIjpbImVuY3J5cHQiLCJrZXkiLCJkYXRhT2JqIiwiY3J5cHRvIiwicmVxdWlyZSIsImxvYWRBcGkiLCJlbmNyeXB0aW9uS2V5IiwiZGVyaXZlRW5jcnlwdGlvbktleSIsImVuY3J5cHRlZENyZWRlbnRpYWxzIiwiSlNPTiIsInN0cmluZ2lmeSIsImUiLCJkZWNyeXB0IiwiZGVjcnlwdERhdGEiLCIkJCIsIkJ1ZmZlciIsImZyb20iLCJwYXJzZSIsInRvU3RyaW5nIiwiZ2VuZXJhdGVSYW5kb20iLCJjaGFyYWN0ZXJzU2V0IiwibGVuZ3RoIiwicmVzdWx0IiwiY2hhcmFjdGVyc0xlbmd0aCIsImkiLCJjaGFyQXQiLCJNYXRoIiwiZmxvb3IiLCJyYW5kb20iLCJjaGFyYWN0ZXJzIiwiZ2V0U2VjcmV0TG9jYWxUb2tlbiIsInN0b3JhZ2UiLCJkZXZlbG9wbWVudCIsIm1vYmlsZSIsInN0b3JhZ2VLZXkiLCJzZWNyZXQiLCJnZXRJdGVtIiwic2V0SXRlbSIsInJ1bkluQXV0b0xvZ2luIiwiY3JlZGVudGlhbHMiLCJjb25maWciLCJjcmVkZW50aWFsc01hbmFnZXIiLCJ3YWxsZXRTZXJ2aWNlIiwiY2FsbGJhY2siLCJjcmVhdGUiLCJlcnIiLCJ3YWxsZXQiLCJzYXZlQ3JlZGVudGlhbHMiLCJkZWZhdWx0UGluIiwid3JpdGVGaWxlIiwiTG9hZGVyQ29uc3RhbnRzIiwiVVNFUl9ERVRBSUxTX0ZJTEUiLCJjb25zb2xlIiwibG9nIiwiZ2V0Q3JlYXRpb25TU0kiLCJnZXRMb2dpbkJ5TW9kZSIsImVudmlyb25tZW50IiwibW9kZSIsIkxvYWRlck1vZGUiLCJFWFRFUk5BTF9BVVRPIiwic3Bpbm5lciIsIkVycm9yIiwiT2JqZWN0IiwidmFsdWVzIiwibG9hZENyZWRlbnRpYWxzIiwidW5kZWZpbmVkIiwiREVWX0FVVE8iLCJNT0JJTEVfQVVUTyIsIkFVVE8iLCJERVZfU0VDVVJFIiwiU0VDVVJFIl0sIm1hcHBpbmdzIjoi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QUFzQ2pCLFFBQXRDLEtBQW1EO0FBQ3RETCxRQUFBQSxjQUFjLENBQUNDLFdBQUQsRUFBY0MsTUFBZCxFQUFzQlQsT0FBdEIsRUFBK0JVLGtCQUEvQixFQUFtREMsYUFBbkQsRUFBa0UsS0FBbEUsRUFBeUUsS0FBekUsRUFBZ0ZDLFFBQWhGLENBQWQ7QUFDSCxPQUZEOztBQUdKLFNBQUtlLGtCQUFXVyxVQUFoQjtBQUNBLFNBQUtYLGtCQUFXWSxNQUFoQjtBQUNBO0FBQ0ksYUFBT0wsU0FBUDtBQWpDUjtBQW1DSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExvYWRlck1vZGUgfSBmcm9tIFwiLi4vdHlwZXNcIjtcbmltcG9ydCB7IExvYWRlckNvbnN0YW50cyB9IGZyb20gXCIuL2NvbnN0YW50c1wiO1xuZXhwb3J0IGZ1bmN0aW9uIGVuY3J5cHQoa2V5LCBkYXRhT2JqKSB7XG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnb3BlbmRzdScpLmxvYWRBcGkoJ2NyeXB0bycpO1xuICAgICAgICBjb25zdCBlbmNyeXB0aW9uS2V5ID0gY3J5cHRvLmRlcml2ZUVuY3J5cHRpb25LZXkoa2V5KTtcbiAgICAgICAgY29uc3QgZW5jcnlwdGVkQ3JlZGVudGlhbHMgPSBjcnlwdG8uZW5jcnlwdChKU09OLnN0cmluZ2lmeShkYXRhT2JqKSwgZW5jcnlwdGlvbktleSk7XG4gICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShlbmNyeXB0ZWRDcmVkZW50aWFscyk7XG4gICAgfVxuICAgIGNhdGNoIChlKSB7XG4gICAgICAgIHRocm93IGU7XG4gICAgfVxufVxuZXhwb3J0IGZ1bmN0aW9uIGRlY3J5cHQoa2V5LCBkYXRhT2JqKSB7XG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnb3BlbmRzdScpLmxvYWRBcGkoJ2NyeXB0bycpO1xuICAgICAgICBjb25zdCBlbmNyeXB0aW9uS2V5ID0gY3J5cHRvLmRlcml2ZUVuY3J5cHRpb25LZXkoa2V5KTtcbiAgICAgICAgY29uc3QgZGVjcnlwdERhdGEgPSBjcnlwdG8uZGVjcnlwdCgkJC5CdWZmZXIuZnJvbShKU09OLnBhcnNlKGRhdGFPYmopKSwgZW5jcnlwdGlvbktleSk7XG4gICAgICAgIHJldHVybiBKU09OLnBhcnNlKGRlY3J5cHREYXRhLnRvU3RyaW5nKCkpO1xuICAgIH1cbiAgICBjYXRjaCAoZSkge1xuICAgICAgICB0aHJvdyBlO1xuICAgIH1cbn1cbmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZVJhbmRvbShjaGFyYWN0ZXJzU2V0LCBsZW5ndGgpIHtcbiAgICBsZXQgcmVzdWx0ID0gJyc7XG4gICAgY29uc3QgY2hhcmFjdGVyc0xlbmd0aCA9IGNoYXJhY3RlcnNTZXQubGVuZ3RoO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspXG4gICAgICAgIHJlc3VsdCArPSBjaGFyYWN0ZXJzU2V0LmNoYXJBdChNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBjaGFyYWN0ZXJzTGVuZ3RoKSk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbn1cbmNvbnN0IGNoYXJhY3RlcnMgPSAnQUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVphYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5ejAxMjM0NTY3ODknO1xuZnVuY3Rpb24gZ2V0U2VjcmV0TG9jYWxUb2tlbihzdG9yYWdlLCBkZXZlbG9wbWVudCwgbW9iaWxlLCBzdG9yYWdlS2V5KSB7XG4gICAgaWYgKG1vYmlsZSlcbiAgICAgICAgcmV0dXJuIFwiU3VwZXJVc2VyU2VjdXJlUGFzc3dvcmQxIVwiO1xuICAgIGlmICh0eXBlb2Ygc3RvcmFnZUtleSA9PT0gXCJ1bmRlZmluZWRcIilcbiAgICAgICAgc3RvcmFnZUtleSA9IFwic2VjcmV0VG9rZW5cIjtcbiAgICBpZiAoZGV2ZWxvcG1lbnQpXG4gICAgICAgIHJldHVybiBnZW5lcmF0ZVJhbmRvbShjaGFyYWN0ZXJzLCAzMik7XG4gICAgbGV0IHNlY3JldCA9IHN0b3JhZ2UuZ2V0SXRlbShzdG9yYWdlS2V5KTtcbiAgICBpZiAoIXNlY3JldCkge1xuICAgICAgICBzZWNyZXQgPSBnZW5lcmF0ZVJhbmRvbShjaGFyYWN0ZXJzLCAzMik7XG4gICAgICAgIHN0b3JhZ2Uuc2V0SXRlbShzdG9yYWdlS2V5LCBzZWNyZXQpO1xuICAgIH1cbiAgICByZXR1cm4gc2VjcmV0O1xufVxuZXhwb3J0IGZ1bmN0aW9uIHJ1bkluQXV0b0xvZ2luKGNyZWRlbnRpYWxzLCBjb25maWcsIHN0b3JhZ2UsIGNyZWRlbnRpYWxzTWFuYWdlciwgd2FsbGV0U2VydmljZSwgZGV2ZWxvcG1lbnQsIG1vYmlsZSwgY2FsbGJhY2spIHtcbiAgICBjcmVkZW50aWFscyA9IFtnZXRTZWNyZXRMb2NhbFRva2VuKHN0b3JhZ2UsIGRldmVsb3BtZW50LCBtb2JpbGUpXTtcbiAgICB3YWxsZXRTZXJ2aWNlLmNyZWF0ZShjcmVkZW50aWFscywgKGVyciwgd2FsbGV0KSA9PiB7XG4gICAgICAgIGlmIChlcnIpXG4gICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soZXJyKTtcbiAgICAgICAgaWYgKCFkZXZlbG9wbWVudClcbiAgICAgICAgICAgIGNyZWRlbnRpYWxzTWFuYWdlci5zYXZlQ3JlZGVudGlhbHMoY29uZmlnLmRlZmF1bHRQaW4sIGNyZWRlbnRpYWxzKTtcbiAgICAgICAgd2FsbGV0LndyaXRlRmlsZShMb2FkZXJDb25zdGFudHMuVVNFUl9ERVRBSUxTX0ZJTEUsIEpTT04uc3RyaW5naWZ5KGNyZWRlbnRpYWxzKSwgKGVycikgPT4ge1xuICAgICAgICAgICAgaWYgKGVycilcbiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soZXJyKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiQSBuZXcgd2FsbGV0IGdvdCBpbml0aWFsaXNlZC4uLlwiLCB3YWxsZXQuZ2V0Q3JlYXRpb25TU0kodHJ1ZSkpO1xuICAgICAgICAgICAgY2FsbGJhY2soKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59XG5leHBvcnQgZnVuY3Rpb24gZ2V0TG9naW5CeU1vZGUoZW52aXJvbm1lbnQsIGNvbmZpZywgY3JlZGVudGlhbHNNYW5hZ2VyLCBzdG9yYWdlKSB7XG4gICAgc3dpdGNoIChlbnZpcm9ubWVudC5tb2RlKSB7XG4gICAgICAgIGNhc2UgTG9hZGVyTW9kZS5FWFRFUk5BTF9BVVRPOlxuICAgICAgICAgICAgcmV0dXJuIChjcmVkZW50aWFscywgd2FsbGV0U2VydmljZSwgc3Bpbm5lciwgY2FsbGJhY2spID0+IHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbmZpZy5kZWZhdWx0UGluKVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG5ldyBFcnJvcihgTWlzc2luZyBhIGRlZmF1bHQgcGluYCkpO1xuICAgICAgICAgICAgICAgICAgICBjcmVkZW50aWFscyA9IE9iamVjdC52YWx1ZXMoY3JlZGVudGlhbHNNYW5hZ2VyLmxvYWRDcmVkZW50aWFscyhjb25maWcuZGVmYXVsdFBpbikpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHdhbGxldFNlcnZpY2UuY3JlYXRlKGNyZWRlbnRpYWxzLCAoZXJyLCB3YWxsZXQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycilcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhlcnIpO1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkEgbmV3IHdhbGxldCBnb3QgaW5pdGlhbGlzZWQuLi5cIiwgd2FsbGV0LmdldENyZWF0aW9uU1NJKHRydWUpKTtcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sodW5kZWZpbmVkLCB3YWxsZXQpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgY2FzZSBMb2FkZXJNb2RlLkRFVl9BVVRPOlxuICAgICAgICAgICAgcmV0dXJuIChjcmVkZW50aWFscywgd2FsbGV0U2VydmljZSwgc3Bpbm5lciwgY2FsbGJhY2spID0+IHtcbiAgICAgICAgICAgICAgICBydW5JbkF1dG9Mb2dpbihjcmVkZW50aWFscywgY29uZmlnLCBzdG9yYWdlLCBjcmVkZW50aWFsc01hbmFnZXIsIHdhbGxldFNlcnZpY2UsIHRydWUsIGZhbHNlLCBjYWxsYmFjayk7XG4gICAgICAgICAgICB9O1xuICAgICAgICBjYXNlIExvYWRlck1vZGUuTU9CSUxFX0FVVE86XG4gICAgICAgICAgICByZXR1cm4gKGNyZWRlbnRpYWxzLCB3YWxsZXRTZXJ2aWNlLCBzcGlubmVyLCBjYWxsYmFjaykgPT4ge1xuICAgICAgICAgICAgICAgIHJ1bkluQXV0b0xvZ2luKGNyZWRlbnRpYWxzLCBjb25maWcsIHN0b3JhZ2UsIGNyZWRlbnRpYWxzTWFuYWdlciwgd2FsbGV0U2VydmljZSwgZmFsc2UsIHRydWUsIGNhbGxiYWNrKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIGNhc2UgTG9hZGVyTW9kZS5BVVRPOlxuICAgICAgICAgICAgcmV0dXJuIChjcmVkZW50aWFscywgd2FsbGV0U2VydmljZSwgc3Bpbm5lciwgY2FsbGJhY2spID0+IHtcbiAgICAgICAgICAgICAgICBydW5JbkF1dG9Mb2dpbihjcmVkZW50aWFscywgY29uZmlnLCBzdG9yYWdlLCBjcmVkZW50aWFsc01hbmFnZXIsIHdhbGxldFNlcnZpY2UsIGZhbHNlLCBmYWxzZSwgY2FsbGJhY2spO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgY2FzZSBMb2FkZXJNb2RlLkRFVl9TRUNVUkU6XG4gICAgICAgIGNhc2UgTG9hZGVyTW9kZS5TRUNVUkU6XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbn0iXSwiZmlsZSI6InNlcnZpY2VzL3V0aWxzLmpzIn0=
