"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.CredentialsManager = void 0;

var _utils = require("./utils");

var _storage = require("./storage");

var _constants = require("./constants");

class CredentialsManager {
  constructor(appName, storage) {
    this.appName = appName;
    this.storage = storage || new _storage.LoaderLocalStorage();
  }

  getCredentialsKey() {
    return this.appName + _constants.StorageKeys.CREDENTIALS;
  }

  getPinCodeKey() {
    return this.appName + _constants.StorageKeys.PINCODE;
  }

  saveCredentials(pinCode, credentials) {
    var encryptedCredentials = (0, _utils.encrypt)(pinCode, credentials);
    this.storage.setItem(this.getCredentialsKey(), encryptedCredentials);
  }

  savePinCode(pinCode, credentials) {
    var encryptedCredentials = (0, _utils.encrypt)(pinCode, credentials);
    this.storage.setItem(pinCode, encryptedCredentials);
    this.addPin(pinCode);
  }

  addPin(pinCode) {
    var pinArr = this.storage.getItem(this.getPinCodeKey());

    if (!pinArr) {
      pinArr = [pinCode];
    } else {
      pinArr = JSON.parse(pinArr);
      pinArr.push(pinCode);
    }

    this.storage.setItem(this.getPinCodeKey(), JSON.stringify(pinArr));
  }

  removePin(pinCode) {
    var pinArr = this.storage.getItem(this.getPinCodeKey());

    if (pinArr) {
      pinArr = JSON.parse(pinArr);
      pinArr = pinArr.filter(elem => elem !== pinCode);
      this.storage.setItem(this.getPinCodeKey(), JSON.stringify(pinArr));
    } else {
      throw new Error("No pin found");
    }
  }

  loadPinCodeCredentials(pinCode) {
    var pinCodeCredentials = this.storage.getItem(pinCode);

    if (!pinCodeCredentials) {
      pinCodeCredentials = {};
    } else {
      pinCodeCredentials = (0, _utils.decrypt)(pinCode, pinCodeCredentials);
    }

    return pinCodeCredentials;
  }

  changePinCode(newPin, oldPin) {
    var pinCredentials = this.storage.getItem(oldPin);
    if (!pinCredentials) throw new Error("Could not find a stored pin");
    this.storage.setItem(newPin, pinCredentials);
    this.storage.removeItem(oldPin);
  }

  hasPinCodes() {
    return !!this.storage.getItem(this.getPinCodeKey());
  }

  getLastPinCode() {
    var pinArr = this.storage.getItem(this.getPinCodeKey());

    if (!pinArr) {
      return;
    } else {
      var arr = JSON.parse(pinArr);
      return arr[arr.length - 1];
    }
  }

  pinCodeExists(pinCode) {
    var pinArr = this.storage.getItem(this.getPinCodeKey());

    if (!pinArr) {
      return false;
    } else {
      return pinArr.indexOf(pinCode) >= 0;
    }
  }

  loadCredentials(defaultPin) {
    var knownCredentials = this.storage.getItem(this.getCredentialsKey());
    if (!knownCredentials) return {};else return (0, _utils.decrypt)(defaultPin, knownCredentials);
  }

  clearCredentials() {
    this.storage.removeItem(this.getCredentialsKey());
  }

}

exports.CredentialsManager = CredentialsManager;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZpY2VzL2NyZWRlbnRpYWxzLmpzIl0sIm5hbWVzIjpbIkNyZWRlbnRpYWxzTWFuYWdlciIsImNvbnN0cnVjdG9yIiwiYXBwTmFtZSIsInN0b3JhZ2UiLCJMb2FkZXJMb2NhbFN0b3JhZ2UiLCJnZXRDcmVkZW50aWFsc0tleSIsIlN0b3JhZ2VLZXlzIiwiQ1JFREVOVElBTFMiLCJnZXRQaW5Db2RlS2V5IiwiUElOQ09ERSIsInNhdmVDcmVkZW50aWFscyIsInBpbkNvZGUiLCJjcmVkZW50aWFscyIsImVuY3J5cHRlZENyZWRlbnRpYWxzIiwic2V0SXRlbSIsInNhdmVQaW5Db2RlIiwiYWRkUGluIiwicGluQXJyIiwiZ2V0SXRlbSIsIkpTT04iLCJwYXJzZSIsInB1c2giLCJzdHJpbmdpZnkiLCJyZW1vdmVQaW4iLCJmaWx0ZXIiLCJlbGVtIiwiRXJyb3IiLCJsb2FkUGluQ29kZUNyZWRlbnRpYWxzIiwicGluQ29kZUNyZWRlbnRpYWxzIiwiY2hhbmdlUGluQ29kZSIsIm5ld1BpbiIsIm9sZFBpbiIsInBpbkNyZWRlbnRpYWxzIiwicmVtb3ZlSXRlbSIsImhhc1BpbkNvZGVzIiwiZ2V0TGFzdFBpbkNvZGUiLCJhcnIiLCJsZW5ndGgiLCJwaW5Db2RlRXhpc3RzIiwiaW5kZXhPZiIsImxvYWRDcmVkZW50aWFscyIsImRlZmF1bHRQaW4iLCJrbm93bkNyZWRlbnRpYWxzIiwiY2xlYXJDcmVkZW50aWFscyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNPLE1BQU1BLGtCQUFOLENBQXlCO0FBQzVCQyxFQUFBQSxXQUFXLENBQUNDLE9BQUQsRUFBVUMsT0FBVixFQUFtQjtBQUMxQixTQUFLRCxPQUFMLEdBQWVBLE9BQWY7QUFDQSxTQUFLQyxPQUFMLEdBQWVBLE9BQU8sSUFBSSxJQUFJQywyQkFBSixFQUExQjtBQUNIOztBQUNEQyxFQUFBQSxpQkFBaUIsR0FBRztBQUNoQixXQUFPLEtBQUtILE9BQUwsR0FBZUksdUJBQVlDLFdB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dXRpbHNcIjtcbmltcG9ydCB7IExvYWRlckxvY2FsU3RvcmFnZSB9IGZyb20gXCIuL3N0b3JhZ2VcIjtcbmltcG9ydCB7IFN0b3JhZ2VLZXlzIH0gZnJvbSBcIi4vY29uc3RhbnRzXCI7XG5leHBvcnQgY2xhc3MgQ3JlZGVudGlhbHNNYW5hZ2VyIHtcbiAgICBjb25zdHJ1Y3RvcihhcHBOYW1lLCBzdG9yYWdlKSB7XG4gICAgICAgIHRoaXMuYXBwTmFtZSA9IGFwcE5hbWU7XG4gICAgICAgIHRoaXMuc3RvcmFnZSA9IHN0b3JhZ2UgfHwgbmV3IExvYWRlckxvY2FsU3RvcmFnZSgpO1xuICAgIH1cbiAgICBnZXRDcmVkZW50aWFsc0tleSgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBwTmFtZSArIFN0b3JhZ2VLZXlzLkNSRURFTlRJQUxTO1xuICAgIH1cbiAgICBnZXRQaW5Db2RlS2V5KCkge1xuICAgICAgICByZXR1cm4gdGhpcy5hcHBOYW1lICsgU3RvcmFnZUtleXMuUElOQ09ERTtcbiAgICB9XG4gICAgc2F2ZUNyZWRlbnRpYWxzKHBpbkNvZGUsIGNyZWRlbnRpYWxzKSB7XG4gICAgICAgIGNvbnN0IGVuY3J5cHRlZENyZWRlbnRpYWxzID0gZW5jcnlwdChwaW5Db2RlLCBjcmVkZW50aWFscyk7XG4gICAgICAgIHRoaXMuc3RvcmFnZS5zZXRJdGVtKHRoaXMuZ2V0Q3JlZGVudGlhbHNLZXkoKSwgZW5jcnlwdGVkQ3JlZGVudGlhbHMpO1xuICAgIH1cbiAgICBzYXZlUGluQ29kZShwaW5Db2RlLCBjcmVkZW50aWFscykge1xuICAgICAgICBjb25zdCBlbmNyeXB0ZWRDcmVkZW50aWFscyA9IGVuY3J5cHQocGluQ29kZSwgY3JlZGVudGlhbHMpO1xuICAgICAgICB0aGlzLnN0b3JhZ2Uuc2V0SXRlbShwaW5Db2RlLCBlbmNyeXB0ZWRDcmVkZW50aWFscyk7XG4gICAgICAgIHRoaXMuYWRkUGluKHBpbkNvZGUpO1xuICAgIH1cbiAgICBhZGRQaW4ocGluQ29kZSkge1xuICAgICAgICBsZXQgcGluQXJyID0gdGhpcy5zdG9yYWdlLmdldEl0ZW0odGhpcy5nZXRQaW5Db2RlS2V5KCkpO1xuICAgICAgICBpZiAoIXBpbkFycikge1xuICAgICAgICAgICAgcGluQXJyID0gW3BpbkNvZGVdO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgcGluQXJyID0gSlNPTi5wYXJzZShwaW5BcnIpO1xuICAgICAgICAgICAgcGluQXJyLnB1c2gocGluQ29kZSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zdG9yYWdlLnNldEl0ZW0odGhpcy5nZXRQaW5Db2RlS2V5KCksIEpTT04uc3RyaW5naWZ5KHBpbkFycikpO1xuICAgIH1cbiAgICByZW1vdmVQaW4ocGluQ29kZSkge1xuICAgICAgICBsZXQgcGluQXJyID0gdGhpcy5zdG9yYWdlLmdldEl0ZW0odGhpcy5nZXRQaW5Db2RlS2V5KCkpO1xuICAgICAgICBpZiAocGluQXJyKSB7XG4gICAgICAgICAgICBwaW5BcnIgPSBKU09OLnBhcnNlKHBpbkFycik7XG4gICAgICAgICAgICBwaW5BcnIgPSBwaW5BcnIuZmlsdGVyKChlbGVtKSA9PiBlbGVtICE9PSBwaW5Db2RlKTtcbiAgICAgICAgICAgIHRoaXMuc3RvcmFnZS5zZXRJdGVtKHRoaXMuZ2V0UGluQ29kZUtleSgpLCBKU09OLnN0cmluZ2lmeShwaW5BcnIpKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIk5vIHBpbiBmb3VuZFwiKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBsb2FkUGluQ29kZUNyZWRlbnRpYWxzKHBpbkNvZGUpIHtcbiAgICAgICAgbGV0IHBpbkNvZGVDcmVkZW50aWFscyA9IHRoaXMuc3RvcmFnZS5nZXRJdGVtKHBpbkNvZGUpO1xuICAgICAgICBpZiAoIXBpbkNvZGVDcmVkZW50aWFscykge1xuICAgICAgICAgICAgcGluQ29kZUNyZWRlbnRpYWxzID0ge307XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBwaW5Db2RlQ3JlZGVudGlhbHMgPSBkZWNyeXB0KHBpbkNvZGUsIHBpbkNvZGVDcmVkZW50aWFscyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHBpbkNvZGVDcmVkZW50aWFscztcbiAgICB9XG4gICAgY2hhbmdlUGluQ29kZShuZXdQaW4sIG9sZFBpbikge1xuICAgICAgICBjb25zdCBwaW5DcmVkZW50aWFscyA9IHRoaXMuc3RvcmFnZS5nZXRJdGVtKG9sZFBpbik7XG4gICAgICAgIGlmICghcGluQ3JlZGVudGlhbHMpXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDb3VsZCBub3QgZmluZCBhIHN0b3JlZCBwaW5cIik7XG4gICAgICAgIHRoaXMuc3RvcmFnZS5zZXRJdGVtKG5ld1BpbiwgcGluQ3JlZGVudGlhbHMpO1xuICAgICAgICB0aGlzLnN0b3JhZ2UucmVtb3ZlSXRlbShvbGRQaW4pO1xuICAgIH1cbiAgICBoYXNQaW5Db2RlcygpIHtcbiAgICAgICAgcmV0dXJuICEhdGhpcy5zdG9yYWdlLmdldEl0ZW0odGhpcy5nZXRQaW5Db2RlS2V5KCkpO1xuICAgIH1cbiAgICBnZXRMYXN0UGluQ29kZSgpIHtcbiAgICAgICAgbGV0IHBpbkFyciA9IHRoaXMuc3RvcmFnZS5nZXRJdGVtKHRoaXMuZ2V0UGluQ29kZUtleSgpKTtcbiAgICAgICAgaWYgKCFwaW5BcnIpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IGFyciA9IEpTT04ucGFyc2UocGluQXJyKTtcbiAgICAgICAgICAgIHJldHVybiBhcnJbYXJyLmxlbmd0aCAtIDFdO1xuICAgICAgICB9XG4gICAgfVxuICAgIHBpbkNvZGVFeGlzdHMocGluQ29kZSkge1xuICAgICAgICBsZXQgcGluQXJyID0gdGhpcy5zdG9yYWdlLmdldEl0ZW0odGhpcy5nZXRQaW5Db2RlS2V5KCkpO1xuICAgICAgICBpZiAoIXBpbkFycikge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHBpbkFyci5pbmRleE9mKHBpbkNvZGUpID49IDA7XG4gICAgICAgIH1cbiAgICB9XG4gICAgbG9hZENyZWRlbnRpYWxzKGRlZmF1bHRQaW4pIHtcbiAgICAgICAgbGV0IGtub3duQ3JlZGVudGlhbHMgPSB0aGlzLnN0b3JhZ2UuZ2V0SXRlbSh0aGlzLmdldENyZWRlbnRpYWxzS2V5KCkpO1xuICAgICAgICBpZiAoIWtub3duQ3JlZGVudGlhbHMpXG4gICAgICAgICAgICByZXR1cm4ge307XG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIHJldHVybiBkZWNyeXB0KGRlZmF1bHRQaW4sIGtub3duQ3JlZGVudGlhbHMpO1xuICAgIH1cbiAgICBjbGVhckNyZWRlbnRpYWxzKCkge1xuICAgICAgICB0aGlzLnN0b3JhZ2UucmVtb3ZlSXRlbSh0aGlzLmdldENyZWRlbnRpYWxzS2V5KCkpO1xuICAgIH1cbn0iXSwiZmlsZSI6InNlcnZpY2VzL2NyZWRlbnRpYWxzLmpzIn0=
