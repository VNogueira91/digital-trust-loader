"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.WalletService = void 0;

var _FileService = require("./FileService");

class WalletService {
  constructor(config, environment, spinner, creationStrategy) {
    this.creationStrategy = undefined;
    this.creationStrategy = creationStrategy;
    this.config = config;
    this.environment = environment;
    this.spinner = spinner;
    this.fileService = new _FileService.FileService();
  }

  getWalletTemplateContent(callback) {
    this.fileService.getFolderContentAsJSON(this.config.walletTemplateFolderName, (err, data) => {
      if (err) return callback(new Error("Failed to get content for " + this.config.walletTemplateFolderName));
      var content;

      try {
        content = JSON.parse(data);
      } catch (e) {
        return callback(new Error("Failed to parse content for " + this.config.walletTemplateFolderName));
      }

      callback(undefined, content);
    });
  }

  dirSummaryAsArray(walletTemplateContent) {
    var files = [];

    for (var directory in walletTemplateContent) {
      var directoryFiles = walletTemplateContent[directory];

      for (var fileName in directoryFiles) {
        files.push({
          path: directory + "/" + fileName,
          content: directoryFiles[fileName]
        });
      }
    }

    return files;
  }

  customizeDSU(dsu, files, prefix, callback) {
    var self = this;

    if (typeof prefix === "function") {
      callback = prefix;
      prefix = undefined;
    }

    if (files.length === 0) {
      return callback();
    }

    var file = files.pop();
    var targetPath = file.path;

    if (typeof prefix !== 'undefined') {
      targetPath = "".concat(prefix, "/").concat(targetPath);
    }

    var fileContent;

    if (Array.isArray(file.content)) {
      var Buffer = require("buffer").Buffer;

      var arrayBuffer = new Uint8Array(file.content).buffer;
      var buffer = new Buffer(arrayBuffer.byteLength);
      var view = new Uint8Array(arrayBuffer);

      for (var i = 0; i < buffer.length; ++i) {
        buffer[i] = view[i];
      }

      fileContent = buffer;
    } else {
      fileContent = file.content;
    }

    dsu.writeFile(targetPath, fileContent, err => {
      if (err) {
        return callback(new Error("Failed to write file in DSU at path ".concat(targetPath, ", ").concat(err)));
      }

      self.customizeDSU(dsu, files, prefix, callback);
    });
  }

  getListOfAppsForInstallation(callback) {
    var self = this;
    this.fileService.getFolderContentAsJSON(this.config.appsFolderName, function (err, data) {
      if (err) return callback(new Error("Failed to get content for folder ".concat(self.config.appsFolderName, ", ").concat(err)));
      var apps;

      try {
        apps = JSON.parse(data);
      } catch (e) {
        return callback(new Error("Failed to parse content for folder ".concat(self.config.appsFolderName, ", ").concat(err)));
      }

      callback(undefined, apps);
    });
  }

  getSSAppsFromInstallationURL(callback) {
    var url = new URL(window.location.href);
    var searchParams = url.searchParams;
    var apps = {};
    searchParams.forEach((paramValue, paramKey) => {
      if (paramKey === "appName") {
        var seedKey = paramValue + "Seed";
        var appSeed = searchParams.get(seedKey);
        if (appSeed) apps[paramValue] = appSeed;
      }
    });
    if (Object.keys(apps)) return callback(undefined, apps);
    callback();
  }

  buildApp(appName, seed, hasTemplate, callback) {
    if (typeof hasTemplate === "function") {
      callback = hasTemplate;
      hasTemplate = true;
    }

    var self = this;

    var instantiateNewDossier = files => {
      var resolver = require("opendsu").loadApi("resolver");

      var keyssi = require("opendsu").loadApi("keyssi");

      resolver.createDSU(keyssi.createTemplateSeedSSI(self.environment.vaultDomain, undefined, undefined, undefined, self.environment.vault), (err, appDSU) => {
        if (err) return callback(new Error("Failed to create DSU ".concat(err)));
        appDSU.mount('/' + self.config.codeFolderName, seed, err => {
          if (err) return callback(new Error("Failed to mount in /code seedSSI ".concat(seed, ", ").concat(err)));
          self.customizeDSU(appDSU, files, "/".concat(self.config.appFolderName), err => {
            if (err) return callback(new Error("Failed to customize DSU ".concat(err)));
            return appDSU.writeFile("/environment.json", JSON.stringify(self.environment), err => {
              if (err) console.log("Could not write environment file into app", err);
              appDSU.getKeySSIAsString(callback);
            });
          });
        });
      });
    };

    if (hasTemplate) {
      return self.fileService.getFolderContentAsJSON("apps-patch/".concat(appName), (err, data) => {
        var files;

        try {
          files = JSON.parse(data);
        } catch (e) {
          return callback(new Error("Failed to get content for folder" + "apps/".concat(appName) + err));
        }

        files = self.dirSummaryAsArray(files);
        instantiateNewDossier(files);
      });
    }

    instantiateNewDossier([]);
  }

  performInstallation(walletDSU, apps, appsList, callback) {
    if (!appsList.length) {
      return callback();
    }

    var appName = appsList.pop();
    var appInfo = apps[appName];
    if (appName[0] === '/') appName = appName.replace('/', '');
    var self = this;

    var mountApp = newAppSeed => {
      walletDSU.mount('/apps/' + appName, newAppSeed, err => {
        if (err) return callback(new Error("Failed to mount in folder" + "/apps/".concat(appName, ": ").concat(err)));
        self.performInstallation(walletDSU, apps, appsList, callback);
      });
    };

    var hasTemplate = appInfo.hasTemplate;
    var newInstanceIsDemanded = appInfo.newInstance;

    if (newInstanceIsDemanded) {
      return self.buildApp(appName, appInfo.seed, hasTemplate, (err, newAppSeed) => {
        if (err) return callback(new Error("Failed to build app " + "".concat(appName, ": ").concat(err)));
        mountApp(newAppSeed);
      });
    }

    mountApp(appInfo.seed);
  }

  installApplications(walletDSU, callback) {
    var self = this;
    self.getListOfAppsForInstallation((err, apps) => {
      var appsToBeInstalled = apps || {};
      self.getSSAppsFromInstallationURL((err, apps) => {
        var externalAppsList = Object.keys(apps);

        if (externalAppsList.length > 0) {
          externalAppsList.forEach(appName => {
            appsToBeInstalled[appName] = {
              hasTemplate: false,
              newInstance: false,
              seed: apps[appName]
            };
          });
          var landingApp = {
            name: externalAppsList[0]
          };
          walletDSU.writeFile("".concat(self.config.appsFolderName, "/.landingApp"), JSON.stringify(landingApp), () => {
            console.log("Written landingApp [".concat(landingApp.name, "]. "));
          });
        }
      });
      var appsList = Object.keys(appsToBeInstalled);

      if (appsList.length === 0) {
        return callback();
      }

      console.log('Installing the following applications: ', appsToBeInstalled, appsList);
      self.performInstallation(walletDSU, appsToBeInstalled, appsList, callback);
    });
  }

  install(wallet, files, callback) {
    var self = this;
    files = this.dirSummaryAsArray(files);
    this.customizeDSU(wallet, files, "/".concat(this.config.appFolderName), err => {
      if (err) return callback(new Error("Failed to customize DSU: ".concat(err)));
      self.installApplications(wallet, callback);
    });
  }

  create(credentials, callback) {
    if (this.creationStrategy) return this.creationStrategy(this.environment.vaultDomain, credentials, this.spinner, function (err) {
      if (err) console.error("Wallet creation strategy failed:", err);

      for (var _len = arguments.length, results = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
        results[_key - 1] = arguments[_key];
      }

      callback(err, ...results);
    });

    var resolver = require("opendsu").loadApi("resolver");

    var keySSISpace = require("opendsu").loadApi("keyssi");

    var {
      vaultDomain,
      vault
    } = this.environment;
    var self = this;

    var build = function build() {
      var {
        walletTemplateFolderName,
        ssiFileName
      } = self.config;
      self.fileService.getFile(walletTemplateFolderName + "/" + ssiFileName, (err, dsuType) => {
        if (err) return callback(err);
        resolver.createDSU(keySSISpace.createTemplateWalletSSI(vaultDomain, credentials, vault), {
          useSSIAsIdentifier: true,
          dsuTypeSSI: dsuType,
          walletKeySSI: self.config.walletKeySSI
        }, (err, walletDSU) => {
          if (err) return callback(err);
          walletDSU = walletDSU.getWritableDSU();
          self.getWalletTemplateContent((err, files) => {
            if (err) return callback(err);
            files['/'][self.config.ssiFileName] = undefined;
            delete files['/'][self.config.ssiFileName];

            if (!self.config.walletKeySSI) {
              self.install(walletDSU, files, err => {
                if (err) return callback(new Error("Failed to install: ".concat(err)));
                return walletDSU.writeFile("/environment.json", JSON.stringify(self.environment), err => {
                  if (err) return callback(new Error("Could not write Environment file into wallet."));
                  callback(undefined, walletDSU);
                });
              });
            } else {
              callback(undefined, walletDSU);
            }
          });
        });
      });
    };

    resolver.loadDSU(keySSISpace.createTemplateWalletSSI(vaultDomain, credentials, vault), (err, walletDSU) => {
      if (err) {
        build();
      } else {
        console.log("Possible security issue. It is ok during development if you use the same credentials. Just do a npm run clean to remove APIHub cache in this case...");
        walletDSU = walletDSU.getWritableDSU();
        callback(err, walletDSU);
      }
    });
  }

  load(credentials, callback) {
    var resolver = require("opendsu").loadApi("resolver");

    var keyssi = require("opendsu").loadApi("keyssi");

    var {
      vaultDomain,
      vault
    } = this.environment;
    var walletSSI = keyssi.createTemplateWalletSSI(vaultDomain, credentials, vault);
    resolver.loadDSU(walletSSI, (err, constDSU) => {
      if (err) {
        console.error(err);
        return callback(new Error("Failed to load wallet"));
      }

      callback(undefined, constDSU.getWritableDSU());
    });
  }

  retrieve() {}

  changePassword() {}

}

exports.WalletService = WalletService;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlcnZpY2VzL3dhbGxldC5qcyJdLCJuYW1lcyI6WyJXYWxsZXRTZXJ2aWNlIiwiY29uc3RydWN0b3IiLCJjb25maWciLCJlbnZpcm9ubWVudCIsInNwaW5uZXIiLCJjcmVhdGlvblN0cmF0ZWd5IiwidW5kZWZpbmVkIiwiZmlsZVNlcnZpY2UiLCJGaWxlU2VydmljZSIsImdldFdhbGxldFRlbXBsYXRlQ29udGVudCIsImNhbGxiYWNrIiwiZ2V0Rm9sZGVyQ29udGVudEFzSlNPTiIsIndhbGxldFRlbXBsYXRlRm9sZGVyTmFtZSIsImVyciIsImRhdGEiLCJFcnJvciIsImNvbnRlbnQiLCJKU09OIiwicGFyc2UiLCJlIiwiZGlyU3VtbWFyeUFzQXJyYXkiLCJ3YWxsZXRUZW1wbGF0ZUNvbnRlbnQiLCJmaWxlcyIsImRpcmVjdG9yeSIsImRpcmVjdG9yeUZpbGVzIiwiZmlsZU5hbWUiLCJwdXNoIiwicGF0aCIsImN1c3RvbWl6ZURTVSIsImRzdSIsInByZWZpeCIsInNlbGYiLCJsZW5ndGgiLCJmaWxlIiwicG9wIiwidGFyZ2V0UGF0aCIsImZpbGVDb250ZW50IiwiQXJyYXkiLCJpc0FycmF5IiwiQnVmZmVyIiwicmVxdWlyZSIsImFycmF5QnVmZmVyIiwiVWludDhBcnJheSIsImJ1ZmZlciIsImJ5dGVMZW5ndGgiLCJ2aWV3IiwiaSIsIndyaXRlRmlsZSIsImdldExpc3RPZkFwcHNGb3JJbnN0YWxsYXRpb24iLCJhcHBzRm9sZGVyTmFtZSIsImFwcHMiLCJnZXRTU0FwcHNGcm9tSW5zdGFsbGF0aW9uVVJMIiwidXJsIiwiVVJMIiwid2luZG93IiwibG9jYXRpb24iLCJocmVmIiwic2VhcmNoUGFyYW1zIiwiZm9yRWFjaCIsInBhcmFtVmFsdWUiLCJwYXJhbUtleSIsInNlZWRLZXkiLCJhcHBTZWVkIiwiZ2V0IiwiT2JqZWN0Iiwia2V5cyIsImJ1aWxkQXBwIiwiYXBwTmFtZSIsInNlZWQiLCJoYXNUZW1wbGF0ZSIsImluc3RhbnRpYXRlTmV3RG9zc2llciIsInJlc29sdmVyIiwibG9hZEFwaSIsImtleXNzaSIsImNyZWF0ZURTVSIsImNyZWF0ZVRlbXBsYXRlU2VlZFNTSSIsInZhdWx0RG9tYWluIiwidmF1bHQiLCJhcHBEU1UiLCJtb3VudCIsImNvZGVGb2xkZXJOYW1lIiwiYXBwRm9sZGVyTmFtZSIsInN0cmluZ2lmeSIsImNvbnNvbGUiLCJsb2ciLCJnZXRLZXlTU0lBc1N0cmluZyIsInBlcmZvcm1JbnN0YWxsYXRpb24iLCJ3YWxsZXREU1UiLCJhcHBzTGlzdCIsImFwcEluZm8iLCJyZXBsYWNlIiwibW91bnRBcHAiLCJuZXdBcHBTZWVkIiwibmV3SW5zdGFuY2VJc0RlbWFuZGVkIiwibmV3SW5zdGFuY2UiLCJpbnN0YWxsQXBwbGljYXRpb25zIiwiYXBwc1RvQmVJbnN0YWxsZWQiLCJleHRlcm5hbEFwcHNMaXN0IiwibGFuZGluZ0FwcCIsIm5hbWUiLCJpbnN0YWxsIiwid2FsbGV0IiwiY3JlYXRlIiwiY3JlZGVudGlhbHMiLCJlcnJvciIsInJlc3VsdHMiLCJrZXlTU0lTcGFjZSIsImJ1aWxkIiwic3NpRmlsZU5hbWUiLCJnZXRGaWxlIiwiZHN1VHlwZSIsImNyZWF0ZVRlbXBsYXRlV2FsbGV0U1NJIiwidXNlU1NJQXNJZGVudGlmaWVyIiwiZHN1VHlwZVNTSSIsIndhbGxldEtleVNTSSIsImdldFdyaXRhYmxlRFNVIiwibG9hZERTVSIsImxvYWQiLCJ3YWxsZXRTU0kiLCJjb25zdERTVSIsInJldHJpZXZlIiwiY2hhbmdlUGFzc3dvcmQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDTyxNQUFNQSxhQUFOLENBQW9CO0FBQ3ZCQyxFQUFBQSxXQUFXLENBQUNDLE1BQUQsRUFBU0MsV0FBVCxFQUFzQkMsT0FBdEIsRUFBK0JDLGdCQUEvQixFQUFpRDtBQUN4RCxTQUFLQSxnQkFBTCxHQUF3QkMsU0FBeEI7QUFDQSxTQUFLRCxnQkFBTCxHQUF3QkEsZ0JBQXhCO0FBQ0EsU0FBS0gsTUFBTCxHQUFjQSxNQUFkO0FBQ0EsU0FBS0MsV0FBTCxHQUFt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LENBQUNKLGNBQVQsRUFBWixDQUFSO0FBQ0gsS0FORDtBQU9IOztBQUNESyxFQUFBQSxRQUFRLEdBQUcsQ0FDVjs7QUFDREMsRUFBQUEsY0FBYyxHQUFHLENBQ2hCOztBQXRSc0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBGaWxlU2VydmljZSB9IGZyb20gXCIuL0ZpbGVTZXJ2aWNlXCI7XG5leHBvcnQgY2xhc3MgV2FsbGV0U2VydmljZSB7XG4gICAgY29uc3RydWN0b3IoY29uZmlnLCBlbnZpcm9ubWVudCwgc3Bpbm5lciwgY3JlYXRpb25TdHJhdGVneSkge1xuICAgICAgICB0aGlzLmNyZWF0aW9uU3RyYXRlZ3kgPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMuY3JlYXRpb25TdHJhdGVneSA9IGNyZWF0aW9uU3RyYXRlZ3k7XG4gICAgICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuICAgICAgICB0aGlzLmVudmlyb25tZW50ID0gZW52aXJvbm1lbnQ7XG4gICAgICAgIHRoaXMuc3Bpbm5lciA9IHNwaW5uZXI7XG4gICAgICAgIHRoaXMuZmlsZVNlcnZpY2UgPSBuZXcgRmlsZVNlcnZpY2UoKTtcbiAgICB9XG4gICAgZ2V0V2FsbGV0VGVtcGxhdGVDb250ZW50KGNhbGxiYWNrKSB7XG4gICAgICAgIHRoaXMuZmlsZVNlcnZpY2UuZ2V0Rm9sZGVyQ29udGVudEFzSlNPTih0aGlzLmNvbmZpZy53YWxsZXRUZW1wbGF0ZUZvbGRlck5hbWUsIChlcnIsIGRhdGEpID0+IHtcbiAgICAgICAgICAgIGlmIChlcnIpXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG5ldyBFcnJvcihcIkZhaWxlZCB0byBnZXQgY29udGVudCBmb3IgXCIgKyB0aGlzLmNvbmZpZy53YWxsZXRUZW1wbGF0ZUZvbGRlck5hbWUpKTtcbiAgICAgICAgICAgIGxldCBjb250ZW50O1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjb250ZW50ID0gSlNPTi5wYXJzZShkYXRhKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG5ldyBFcnJvcihcIkZhaWxlZCB0byBwYXJzZSBjb250ZW50IGZvciBcIiArIHRoaXMuY29uZmlnLndhbGxldFRlbXBsYXRlRm9sZGVyTmFtZSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2FsbGJhY2sodW5kZWZpbmVkLCBjb250ZW50KTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGRpclN1bW1hcnlBc0FycmF5KHdhbGxldFRlbXBsYXRlQ29udGVudCkge1xuICAgICAgICBsZXQgZmlsZXMgPSBbXTtcbiAgICAgICAgZm9yIChsZXQgZGlyZWN0b3J5IGluIHdhbGxldFRlbXBsYXRlQ29udGVudCkge1xuICAgICAgICAgICAgbGV0IGRpcmVjdG9yeUZpbGVzID0gd2FsbGV0VGVtcGxhdGVDb250ZW50W2RpcmVjdG9yeV07XG4gICAgICAgICAgICBmb3IgKGxldCBmaWxlTmFtZSBpbiBkaXJlY3RvcnlGaWxlcylcbiAgICAgICAgICAgICAgICBmaWxlcy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgcGF0aDogZGlyZWN0b3J5ICsgXCIvXCIgKyBmaWxlTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgY29udGVudDogZGlyZWN0b3J5RmlsZXNbZmlsZU5hbWVdXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZpbGVzO1xuICAgIH1cbiAgICA7XG4gICAgY3VzdG9taXplRFNVKGRzdSwgZmlsZXMsIHByZWZpeCwgY2FsbGJhY2spIHtcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gICAgICAgIGlmICh0eXBlb2YgcHJlZml4ID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgICAgIGNhbGxiYWNrID0gcHJlZml4O1xuICAgICAgICAgICAgcHJlZml4ID0gdW5kZWZpbmVkO1xuICAgICAgICB9XG4gICAgICAgIGlmIChmaWxlcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiBjYWxsYmFjaygpO1xuICAgICAgICB9XG4gICAgICAgIGxldCBmaWxlID0gZmlsZXMucG9wKCk7XG4gICAgICAgIGxldCB0YXJnZXRQYXRoID0gZmlsZS5wYXRoO1xuICAgICAgICBpZiAodHlwZW9mIHByZWZpeCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgIHRhcmdldFBhdGggPSBgJHtwcmVmaXh9LyR7dGFyZ2V0UGF0aH1gO1xuICAgICAgICB9XG4gICAgICAgIGxldCBmaWxlQ29udGVudDtcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZmlsZS5jb250ZW50KSkge1xuICAgICAgICAgICAgbGV0IEJ1ZmZlciA9IHJlcXVpcmUoXCJidWZmZXJcIikuQnVmZmVyO1xuICAgICAgICAgICAgbGV0IGFycmF5QnVmZmVyID0gbmV3IFVpbnQ4QXJyYXkoZmlsZS5jb250ZW50KS5idWZmZXI7XG4gICAgICAgICAgICBsZXQgYnVmZmVyID0gbmV3IEJ1ZmZlcihhcnJheUJ1ZmZlci5ieXRlTGVuZ3RoKTtcbiAgICAgICAgICAgIGxldCB2aWV3ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXlCdWZmZXIpO1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBidWZmZXIubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgICAgICAgICBidWZmZXJbaV0gPSB2aWV3W2ldO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZmlsZUNvbnRlbnQgPSBidWZmZXI7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBmaWxlQ29udGVudCA9IGZpbGUuY29udGVudDtcbiAgICAgICAgfVxuICAgICAgICBkc3Uud3JpdGVGaWxlKHRhcmdldFBhdGgsIGZpbGVDb250ZW50LCAoZXJyKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG5ldyBFcnJvcihgRmFpbGVkIHRvIHdyaXRlIGZpbGUgaW4gRFNVIGF0IHBhdGggJHt0YXJnZXRQYXRofSwgJHtlcnJ9YCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc2VsZi5jdXN0b21pemVEU1UoZHN1LCBmaWxlcywgcHJlZml4LCBjYWxsYmFjayk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBnZXRMaXN0T2ZBcHBzRm9ySW5zdGFsbGF0aW9uKGNhbGxiYWNrKSB7XG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuICAgICAgICB0aGlzLmZpbGVTZXJ2aWNlLmdldEZvbGRlckNvbnRlbnRBc0pTT04odGhpcy5jb25maWcuYXBwc0ZvbGRlck5hbWUsIGZ1bmN0aW9uIChlcnIsIGRhdGEpIHtcbiAgICAgICAgICAgIGlmIChlcnIpXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG5ldyBFcnJvcihgRmFpbGVkIHRvIGdldCBjb250ZW50IGZvciBmb2xkZXIgJHtzZWxmLmNvbmZpZy5hcHBzRm9sZGVyTmFtZX0sICR7ZXJyfWApKTtcbiAgICAgICAgICAgIGxldCBhcHBzO1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBhcHBzID0gSlNPTi5wYXJzZShkYXRhKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG5ldyBFcnJvcihgRmFpbGVkIHRvIHBhcnNlIGNvbnRlbnQgZm9yIGZvbGRlciAke3NlbGYuY29uZmlnLmFwcHNGb2xkZXJOYW1lfSwgJHtlcnJ9YCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2FsbGJhY2sodW5kZWZpbmVkLCBhcHBzKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGdldFNTQXBwc0Zyb21JbnN0YWxsYXRpb25VUkwoY2FsbGJhY2spIHtcbiAgICAgICAgbGV0IHVybCA9IG5ldyBVUkwod2luZG93LmxvY2F0aW9uLmhyZWYpO1xuICAgICAgICBsZXQgc2VhcmNoUGFyYW1zID0gdXJsLnNlYXJjaFBhcmFtcztcbiAgICAgICAgbGV0IGFwcHMgPSB7fTtcbiAgICAgICAgc2VhcmNoUGFyYW1zLmZvckVhY2goKHBhcmFtVmFsdWUsIHBhcmFtS2V5KSA9PiB7XG4gICAgICAgICAgICBpZiAocGFyYW1LZXkgPT09IFwiYXBwTmFtZVwiKSB7XG4gICAgICAgICAgICAgICAgbGV0IHNlZWRLZXkgPSBwYXJhbVZhbHVlICsgXCJTZWVkXCI7XG4gICAgICAgICAgICAgICAgbGV0IGFwcFNlZWQgPSBzZWFyY2hQYXJhbXMuZ2V0KHNlZWRLZXkpO1xuICAgICAgICAgICAgICAgIGlmIChhcHBTZWVkKVxuICAgICAgICAgICAgICAgICAgICBhcHBzW3BhcmFtVmFsdWVdID0gYXBwU2VlZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGlmIChPYmplY3Qua2V5cyhhcHBzKSlcbiAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayh1bmRlZmluZWQsIGFwcHMpO1xuICAgICAgICBjYWxsYmFjaygpO1xuICAgIH1cbiAgICBidWlsZEFwcChhcHBOYW1lLCBzZWVkLCBoYXNUZW1wbGF0ZSwgY2FsbGJhY2spIHtcbiAgICAgICAgaWYgKHR5cGVvZiBoYXNUZW1wbGF0ZSA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgICAgICBjYWxsYmFjayA9IGhhc1RlbXBsYXRlO1xuICAgICAgICAgICAgaGFzVGVtcGxhdGUgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuICAgICAgICBjb25zdCBpbnN0YW50aWF0ZU5ld0Rvc3NpZXIgPSAoZmlsZXMpID0+IHtcbiAgICAgICAgICAgIGxldCByZXNvbHZlciA9IHJlcXVpcmUoXCJvcGVuZHN1XCIpLmxvYWRBcGkoXCJyZXNvbHZlclwiKTtcbiAgICAgICAgICAgIGxldCBrZXlzc2kgPSByZXF1aXJlKFwib3BlbmRzdVwiKS5sb2FkQXBpKFwia2V5c3NpXCIpO1xuICAgICAgICAgICAgcmVzb2x2ZXIuY3JlYXRlRFNVKGtleXNzaS5jcmVhdGVUZW1wbGF0ZVNlZWRTU0koc2VsZi5lbnZpcm9ubWVudC52YXVsdERvbWFpbiwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgc2VsZi5lbnZpcm9ubWVudC52YXVsdCksIChlcnIsIGFwcERTVSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChlcnIpXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhuZXcgRXJyb3IoYEZhaWxlZCB0byBjcmVhdGUgRFNVICR7ZXJyfWApKTtcbiAgICAgICAgICAgICAgICBhcHBEU1UubW91bnQoJy8nICsgc2VsZi5jb25maWcuY29kZUZvbGRlck5hbWUsIHNlZWQsIChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycilcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhuZXcgRXJyb3IoYEZhaWxlZCB0byBtb3VudCBpbiAvY29kZSBzZWVkU1NJICR7c2VlZH0sICR7ZXJyfWApKTtcbiAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXN0b21pemVEU1UoYXBwRFNVLCBmaWxlcywgYC8ke3NlbGYuY29uZmlnLmFwcEZvbGRlck5hbWV9YCwgKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycilcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2sobmV3IEVycm9yKGBGYWlsZWQgdG8gY3VzdG9taXplIERTVSAke2Vycn1gKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXBwRFNVLndyaXRlRmlsZShcIi9lbnZpcm9ubWVudC5qc29uXCIsIEpTT04uc3RyaW5naWZ5KHNlbGYuZW52aXJvbm1lbnQpLCAoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycilcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJDb3VsZCBub3Qgd3JpdGUgZW52aXJvbm1lbnQgZmlsZSBpbnRvIGFwcFwiLCBlcnIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcERTVS5nZXRLZXlTU0lBc1N0cmluZyhjYWxsYmFjayk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKGhhc1RlbXBsYXRlKSB7XG4gICAgICAgICAgICByZXR1cm4gc2VsZi5maWxlU2VydmljZS5nZXRGb2xkZXJDb250ZW50QXNKU09OKGBhcHBzLXBhdGNoLyR7YXBwTmFtZX1gLCAoZXJyLCBkYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGZpbGVzO1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGZpbGVzID0gSlNPTi5wYXJzZShkYXRhKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG5ldyBFcnJvcihcIkZhaWxlZCB0byBnZXQgY29udGVudCBmb3IgZm9sZGVyXCIgKyBgYXBwcy8ke2FwcE5hbWV9YCArIGVycikpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBmaWxlcyA9IHNlbGYuZGlyU3VtbWFyeUFzQXJyYXkoZmlsZXMpO1xuICAgICAgICAgICAgICAgIGluc3RhbnRpYXRlTmV3RG9zc2llcihmaWxlcyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBpbnN0YW50aWF0ZU5ld0Rvc3NpZXIoW10pO1xuICAgIH1cbiAgICBwZXJmb3JtSW5zdGFsbGF0aW9uKHdhbGxldERTVSwgYXBwcywgYXBwc0xpc3QsIGNhbGxiYWNrKSB7XG4gICAgICAgIGlmICghYXBwc0xpc3QubGVuZ3RoKSB7XG4gICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soKTtcbiAgICAgICAgfVxuICAgICAgICBsZXQgYXBwTmFtZSA9IGFwcHNMaXN0LnBvcCgpO1xuICAgICAgICBjb25zdCBhcHBJbmZvID0gYXBwc1thcHBOYW1lXTtcbiAgICAgICAgaWYgKGFwcE5hbWVbMF0gPT09ICcvJylcbiAgICAgICAgICAgIGFwcE5hbWUgPSBhcHBOYW1lLnJlcGxhY2UoJy8nLCAnJyk7XG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuICAgICAgICBjb25zdCBtb3VudEFwcCA9IChuZXdBcHBTZWVkKSA9PiB7XG4gICAgICAgICAgICB3YWxsZXREU1UubW91bnQoJy9hcHBzLycgKyBhcHBOYW1lLCBuZXdBcHBTZWVkLCAoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGVycilcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG5ldyBFcnJvcihcIkZhaWxlZCB0byBtb3VudCBpbiBmb2xkZXJcIiArIGAvYXBwcy8ke2FwcE5hbWV9OiAke2Vycn1gKSk7XG4gICAgICAgICAgICAgICAgc2VsZi5wZXJmb3JtSW5zdGFsbGF0aW9uKHdhbGxldERTVSwgYXBwcywgYXBwc0xpc3QsIGNhbGxiYWNrKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgICAgICBsZXQgaGFzVGVtcGxhdGUgPSBhcHBJbmZvLmhhc1RlbXBsYXRlO1xuICAgICAgICBsZXQgbmV3SW5zdGFuY2VJc0RlbWFuZGVkID0gYXBwSW5mby5uZXdJbnN0YW5jZTtcbiAgICAgICAgaWYgKG5ld0luc3RhbmNlSXNEZW1hbmRlZCkge1xuICAgICAgICAgICAgcmV0dXJuIHNlbGYuYnVpbGRBcHAoYXBwTmFtZSwgYXBwSW5mby5zZWVkLCBoYXNUZW1wbGF0ZSwgKGVyciwgbmV3QXBwU2VlZCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChlcnIpXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhuZXcgRXJyb3IoXCJGYWlsZWQgdG8gYnVpbGQgYXBwIFwiICsgYCR7YXBwTmFtZX06ICR7ZXJyfWApKTtcbiAgICAgICAgICAgICAgICBtb3VudEFwcChuZXdBcHBTZWVkKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIG1vdW50QXBwKGFwcEluZm8uc2VlZCk7XG4gICAgfVxuICAgIGluc3RhbGxBcHBsaWNhdGlvbnMod2FsbGV0RFNVLCBjYWxsYmFjaykge1xuICAgICAgICBjb25zdCBzZWxmID0gdGhpcztcbiAgICAgICAgc2VsZi5nZXRMaXN0T2ZBcHBzRm9ySW5zdGFsbGF0aW9uKChlcnIsIGFwcHMpID0+IHtcbiAgICAgICAgICAgIGxldCBhcHBzVG9CZUluc3RhbGxlZCA9IGFwcHMgfHwge307XG4gICAgICAgICAgICBzZWxmLmdldFNTQXBwc0Zyb21JbnN0YWxsYXRpb25VUkwoKGVyciwgYXBwcykgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBleHRlcm5hbEFwcHNMaXN0ID0gT2JqZWN0LmtleXMoYXBwcyk7XG4gICAgICAgICAgICAgICAgaWYgKGV4dGVybmFsQXBwc0xpc3QubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBleHRlcm5hbEFwcHNMaXN0LmZvckVhY2goYXBwTmFtZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcHBzVG9CZUluc3RhbGxlZFthcHBOYW1lXSA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNUZW1wbGF0ZTogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3SW5zdGFuY2U6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlZWQ6IGFwcHNbYXBwTmFtZV1cbiAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICBsZXQgbGFuZGluZ0FwcCA9IHsgbmFtZTogZXh0ZXJuYWxBcHBzTGlzdFswXSB9O1xuICAgICAgICAgICAgICAgICAgICB3YWxsZXREU1Uud3JpdGVGaWxlKGAke3NlbGYuY29uZmlnLmFwcHNGb2xkZXJOYW1lfS8ubGFuZGluZ0FwcGAsIEpTT04uc3RyaW5naWZ5KGxhbmRpbmdBcHApLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgV3JpdHRlbiBsYW5kaW5nQXBwIFske2xhbmRpbmdBcHAubmFtZX1dLiBgKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBjb25zdCBhcHBzTGlzdCA9IE9iamVjdC5rZXlzKGFwcHNUb0JlSW5zdGFsbGVkKTtcbiAgICAgICAgICAgIGlmIChhcHBzTGlzdC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdJbnN0YWxsaW5nIHRoZSBmb2xsb3dpbmcgYXBwbGljYXRpb25zOiAnLCBhcHBzVG9CZUluc3RhbGxlZCwgYXBwc0xpc3QpO1xuICAgICAgICAgICAgc2VsZi5wZXJmb3JtSW5zdGFsbGF0aW9uKHdhbGxldERTVSwgYXBwc1RvQmVJbnN0YWxsZWQsIGFwcHNMaXN0LCBjYWxsYmFjayk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBpbnN0YWxsKHdhbGxldCwgZmlsZXMsIGNhbGxiYWNrKSB7XG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuICAgICAgICBmaWxlcyA9IHRoaXMuZGlyU3VtbWFyeUFzQXJyYXkoZmlsZXMpO1xuICAgICAgICB0aGlzLmN1c3RvbWl6ZURTVSh3YWxsZXQsIGZpbGVzLCBgLyR7dGhpcy5jb25maWcuYXBwRm9sZGVyTmFtZX1gLCAoZXJyKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyKVxuICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhuZXcgRXJyb3IoYEZhaWxlZCB0byBjdXN0b21pemUgRFNVOiAke2Vycn1gKSk7XG4gICAgICAgICAgICBzZWxmLmluc3RhbGxBcHBsaWNhdGlvbnMod2FsbGV0LCBjYWxsYmFjayk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBjcmVhdGUoY3JlZGVudGlhbHMsIGNhbGxiYWNrKSB7XG4gICAgICAgIGlmICh0aGlzLmNyZWF0aW9uU3RyYXRlZ3kpXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGlvblN0cmF0ZWd5KHRoaXMuZW52aXJvbm1lbnQudmF1bHREb21haW4sIGNyZWRlbnRpYWxzLCB0aGlzLnNwaW5uZXIsIChlcnIsIC4uLnJlc3VsdHMpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKVxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBXYWxsZXQgY3JlYXRpb24gc3RyYXRlZ3kgZmFpbGVkOmAsIGVycik7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2soZXJyLCAuLi5yZXN1bHRzKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICBjb25zdCByZXNvbHZlciA9IHJlcXVpcmUoXCJvcGVuZHN1XCIpLmxvYWRBcGkoXCJyZXNvbHZlclwiKTtcbiAgICAgICAgY29uc3Qga2V5U1NJU3BhY2UgPSByZXF1aXJlKFwib3BlbmRzdVwiKS5sb2FkQXBpKFwia2V5c3NpXCIpO1xuICAgICAgICBjb25zdCB7IHZhdWx0RG9tYWluLCB2YXVsdCB9ID0gdGhpcy5lbnZpcm9ubWVudDtcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gICAgICAgIGNvbnN0IGJ1aWxkID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgY29uc3QgeyB3YWxsZXRUZW1wbGF0ZUZvbGRlck5hbWUsIHNzaUZpbGVOYW1lIH0gPSBzZWxmLmNvbmZpZztcbiAgICAgICAgICAgIHNlbGYuZmlsZVNlcnZpY2UuZ2V0RmlsZSh3YWxsZXRUZW1wbGF0ZUZvbGRlck5hbWUgKyBcIi9cIiArIHNzaUZpbGVOYW1lLCAoZXJyLCBkc3VUeXBlKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGVycilcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycik7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZXIuY3JlYXRlRFNVKGtleVNTSVNwYWNlLmNyZWF0ZVRlbXBsYXRlV2FsbGV0U1NJKHZhdWx0RG9tYWluLCBjcmVkZW50aWFscywgdmF1bHQpLCB7IHVzZVNTSUFzSWRlbnRpZmllcjogdHJ1ZSwgZHN1VHlwZVNTSTogZHN1VHlwZSwgd2FsbGV0S2V5U1NJOiBzZWxmLmNvbmZpZy53YWxsZXRLZXlTU0kgfSwgKGVyciwgd2FsbGV0RFNVKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIpXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgd2FsbGV0RFNVID0gd2FsbGV0RFNVLmdldFdyaXRhYmxlRFNVKCk7XG4gICAgICAgICAgICAgICAgICAgIHNlbGYuZ2V0V2FsbGV0VGVtcGxhdGVDb250ZW50KChlcnIsIGZpbGVzKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhlcnIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZmlsZXNbJy8nXVtzZWxmLmNvbmZpZy5zc2lGaWxlTmFtZV0gPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgZmlsZXNbJy8nXVtzZWxmLmNvbmZpZy5zc2lGaWxlTmFtZV07XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXNlbGYuY29uZmlnLndhbGxldEtleVNTSSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaW5zdGFsbCh3YWxsZXREU1UsIGZpbGVzLCAoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2sobmV3IEVycm9yKGBGYWlsZWQgdG8gaW5zdGFsbDogJHtlcnJ9YCkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2FsbGV0RFNVLndyaXRlRmlsZShcIi9lbnZpcm9ubWVudC5qc29uXCIsIEpTT04uc3RyaW5naWZ5KHNlbGYuZW52aXJvbm1lbnQpLCAoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhuZXcgRXJyb3IoXCJDb3VsZCBub3Qgd3JpdGUgRW52aXJvbm1lbnQgZmlsZSBpbnRvIHdhbGxldC5cIikpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sodW5kZWZpbmVkLCB3YWxsZXREU1UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHVuZGVmaW5lZCwgd2FsbGV0RFNVKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcbiAgICAgICAgcmVzb2x2ZXIubG9hZERTVShrZXlTU0lTcGFjZS5jcmVhdGVUZW1wbGF0ZVdhbGxldFNTSSh2YXVsdERvbWFpbiwgY3JlZGVudGlhbHMsIHZhdWx0KSwgKGVyciwgd2FsbGV0RFNVKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgYnVpbGQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiUG9zc2libGUgc2VjdXJpdHkgaXNzdWUuIEl0IGlzIG9rIGR1cmluZyBkZXZlbG9wbWVudCBpZiB5b3UgdXNlIHRoZSBzYW1lIGNyZWRlbnRpYWxzLiBKdXN0IGRvIGEgbnBtIHJ1biBjbGVhbiB0byByZW1vdmUgQVBJSHViIGNhY2hlIGluIHRoaXMgY2FzZS4uLlwiKTtcbiAgICAgICAgICAgICAgICB3YWxsZXREU1UgPSB3YWxsZXREU1UuZ2V0V3JpdGFibGVEU1UoKTtcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhlcnIsIHdhbGxldERTVSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBsb2FkKGNyZWRlbnRpYWxzLCBjYWxsYmFjaykge1xuICAgICAgICBjb25zdCByZXNvbHZlciA9IHJlcXVpcmUoXCJvcGVuZHN1XCIpLmxvYWRBcGkoXCJyZXNvbHZlclwiKTtcbiAgICAgICAgY29uc3Qga2V5c3NpID0gcmVxdWlyZShcIm9wZW5kc3VcIikubG9hZEFwaShcImtleXNzaVwiKTtcbiAgICAgICAgY29uc3QgeyB2YXVsdERvbWFpbiwgdmF1bHQgfSA9IHRoaXMuZW52aXJvbm1lbnQ7XG4gICAgICAgIGNvbnN0IHdhbGxldFNTSSA9IGtleXNzaS5jcmVhdGVUZW1wbGF0ZVdhbGxldFNTSSh2YXVsdERvbWFpbiwgY3JlZGVudGlhbHMsIHZhdWx0KTtcbiAgICAgICAgcmVzb2x2ZXIubG9hZERTVSh3YWxsZXRTU0ksIChlcnIsIGNvbnN0RFNVKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFjayhuZXcgRXJyb3IoXCJGYWlsZWQgdG8gbG9hZCB3YWxsZXRcIikpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2FsbGJhY2sodW5kZWZpbmVkLCBjb25zdERTVS5nZXRXcml0YWJsZURTVSgpKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHJldHJpZXZlKCkge1xuICAgIH1cbiAgICBjaGFuZ2VQYXNzd29yZCgpIHtcbiAgICB9XG59Il0sImZpbGUiOiJzZXJ2aWNlcy93YWxsZXQuanMifQ==
